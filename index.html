<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>団体ナビ成約カルテ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 5px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .app-title h1 {
      margin: 0;
      color: #217346; /* Excel風の緑色 */
    }
    
    .app-info {
      font-size: 14px;
      color: #666;
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    button {
      padding: 8px 16px;
      background-color: #217346;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background-color: #1a5e38;
    }
    
    .section-container {
      margin-bottom: 25px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .section-header {
      padding: 8px 15px;
      font-weight: bold;
      font-size: 16px;
      color: white;
    }
    
    .grid-container {
      height: auto !important;
      overflow: visible !important;
    }
    
    footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    
    /* 各セクション別の色 */
    .basic-section .section-header {
      background-color: #4472C4; /* 青 */
    }
    
    .payment-section .section-header {
      background-color: #70AD47; /* 緑 */
    }
    
    .expense-section .section-header {
      background-color: #ED7D31; /* オレンジ */
    }
    
    .summary-section .section-header {
      background-color: #7030A0; /* 紫 */
    }
    
    /* 行追加ボタン */
    .add-row-btn {
      margin: 5px 10px 10px 0;
      padding: 5px 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    
    .add-row-btn:hover {
      background-color: #45a049;
    }
    
    /* モーダル */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    
    .modal-content {
      position: relative;
      background-color: white;
      margin: 50px auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* 通知 */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
    }
    
    /* スクロールバーを完全に非表示にする追加スタイル */
    /* Handsontableのスクロールバーを非表示に */
    .handsontable .wtHolder, 
    .handsontable .ht_master .wtHolder,
    .handsontable .wtHider {
      overflow: visible !important;
      height: auto !important;
    }
    
    /* テーブル自体の高さも自動に */
    .handsontable {
      height: auto !important;
    }
    
    /* テーブルの全セルを表示 */
    .handsontable .htCore {
      height: auto !important; 
    }
    
    /* スクロールバー要素そのものを非表示に */
    .handsontable ::-webkit-scrollbar {
      display: none !important;
    }
    
    /* IEとEdge用 */
    .handsontable {
      -ms-overflow-style: none !important;
    }
    
    /* Firefox用 */
    .handsontable {
      scrollbar-width: none !important;
    }
    
    /* ホットテーブルのビューポート制限を解除 */
    .handsontable .wtSpreader {
      height: auto !important;
      width: auto !important;
    }
    
    /* handosontableの上部コントロールバーを調整 */
    .ht_clone_top {
      z-index: 101 !important;
    }
    
    /* カルテ一覧テーブルのスタイル */
    #karte-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    #karte-list th, #karte-list td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    
    #karte-list th {
      background-color: #f2f2f2;
    }
    
    #karte-list tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    
    #karte-list tr:hover {
      background-color: #f1f1f1;
    }
    
    .search-container {
      margin-bottom: 10px;
    }
    
    #search {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    .edit-btn, .delete-btn {
      padding: 5px 10px;
      margin-right: 5px;
      font-size: 12px;
    }
    
    .delete-btn {
      background-color: #f44336;
    }
    
    .delete-btn:hover {
      background-color: #d32f2f;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="app-title">
        <h1>団体ナビ成約カルテ</h1>
      </div>
      <div class="app-info">
        <div>カルテID: <span id="current-karte-id">新規カルテ</span></div>
        <div>最終更新: <span id="last-saved">-</span></div>
      </div>
    </header>

    <div class="action-buttons">
      <button id="save-btn">保存</button>
      <button id="new-btn">新規</button>
      <button id="open-btn">開く</button>
      <button id="export-btn">エクスポート</button>
    </div>

    <main>
      <!-- すべてのセクションを縦に並べて表示 -->
      <div class="section-container basic-section" id="basic-section">
        <div class="section-header">◆ 基本情報</div>
        <div id="basic-grid" class="grid-container"></div>
      </div>
      
      <div class="section-container payment-section" id="payment-section">
        <div class="section-header">◆ 入金情報</div>
        <div id="payment-grid" class="grid-container"></div>
        <button id="add-payment-row" class="add-row-btn">行を追加</button>
      </div>
      
      <div class="section-container expense-section" id="expense-section">
        <div class="section-header">◆ 支払情報</div>
        <div id="expense-grid" class="grid-container"></div>
        <button id="add-expense-row" class="add-row-btn">行を追加</button>
      </div>
      
      <div class="section-container summary-section" id="summary-section">
        <div class="section-header">◆ 収支情報</div>
        <div id="summary-grid" class="grid-container"></div>
      </div>
    </main>

    <footer>
      <div>カルテシステム v1.0</div>
      <div>接続状態: <span id="connection-status">オンライン</span></div>
    </footer>
  </div>

  <!-- カルテ一覧モーダル -->
  <div id="list-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>カルテ一覧</h2>
      
      <div class="search-container">
        <input type="text" id="search" placeholder="検索...">
      </div>
      
      <table id="karte-list">
        <thead>
          <tr>
            <th>カルテNo</th>
            <th>お客様担当者</th>
            <th>団体名</th>
            <th>宿泊日</th>
            <th>人数</th>
            <th>行先</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <!-- データはJSで追加 -->
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- 通知 -->
  <div id="notification" class="notification"></div>

  <!-- スクリプト -->
  <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <script>
    // Firebase設定
    const firebaseConfig = {
      apiKey: "AIzaSyBJmvoumJa1zcNBMNcJt4LP2Zjd2LbzEG0",
      authDomain: "travelkarute.firebaseapp.com",
      projectId: "travelkarute",
      storageBucket: "travelkarute.appspot.com", // 修正: storageBucketの値
      messagingSenderId: "635350270309",
      appId: "1:635350270309:web:2498d21f9f134defeda18c"
    };
    
    // Firebase初期化
    let db = null;
    
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      
      // オフラインパーシステンスを有効化（可能であれば）
      try {
        db.enablePersistence({ synchronizeTabs: true })
          .catch(function(err) {
            if (err.code == 'failed-precondition') {
              console.warn("Firestore オフラインパーシステンスは複数タブでは使用できません");
            } else if (err.code == 'unimplemented') {
              console.warn("このブラウザではFirestore オフラインパーシステンスがサポートされていません");
            }
          });
      } catch (e) {
        console.warn("オフラインパーシステンスの設定エラー:", e);
      }
    } catch (error) {
      console.error("Firebase初期化エラー:", error);
      setTimeout(() => {
        alert("サーバー接続に問題が発生しました。ページをリロードしてください。");
      },
      
      // 変更があったことをマーク
      markHasChanges: function() {
        this.hasChanges = true;
      },
      
      // 行数を取得
      getRowCount: function(gridName) {
        if (!this.grids[gridName]) return 0;
        return this.grids[gridName].countRows();
      },
      
      // 数値に変換（カンマや通貨記号を除去）
      parseNumber: function(value) {
        if (value === null || value === undefined || value === '') return 0;
        if (typeof value === 'number') return value;
        
        // 文字列に変換してカンマや通貨記号を除去
        const cleanValue = String(value).replace(/[^\d.-]/g, '');
        const number = parseFloat(cleanValue);
        
        return isNaN(number) ? 0 : number;
      },
      
      // 深いコピーを作成
      deepCopy: function(obj) {
        return JSON.parse(JSON.stringify(obj));
      },
      
      // テーブルの高さを自動調整するヘルパーメソッド
      adjustTableHeights: function() {
        ['basic', 'payment', 'expense', 'summary'].forEach(gridName => {
          if (this.grids[gridName]) {
            const grid = this.grids[gridName];
            try {
              // テーブルを再描画
              grid.render();
              
              // テーブルの実際の高さを取得
              const table = grid.rootElement.querySelector('.htCore');
              if (table) {
                const tableHeight = table.offsetHeight;
                
                // テーブル要素の高さを設定
                grid.rootElement.style.height = tableHeight + 'px';
                
                // コンテナの高さも調整
                const container = grid.rootElement.closest('.grid-container');
                if (container) {
                  container.style.height = 'auto';
                }
                
                // 必要に応じてスプレッダーとホルダーの高さも調整
                const wtHolder = grid.rootElement.querySelector('.wtHolder');
                if (wtHolder) {
                  wtHolder.style.height = 'auto';
                }
                
                const wtSpreader = grid.rootElement.querySelector('.wtSpreader');
                if (wtSpreader) {
                  wtSpreader.style.height = 'auto';
                }
              }
            } catch (e) {
              console.error(`${gridName}の高さ調整中にエラー:`, e);
            }
          }
        });
      }
    };
    
    // アプリケーション初期化
    document.addEventListener('DOMContentLoaded', function() {
      KarteApp.init();
    });
  </script>
</body>
</html>
      
      // Excelにエクスポート
      exportToExcel: function() {
        try {
          // ワークブックを作成
          const wb = XLSX.utils.book_new();
          
          // 各シートを追加
          const basicWs = XLSX.utils.aoa_to_sheet(this.grids.basic.getData());
          XLSX.utils.book_append_sheet(wb, basicWs, '基本情報');
          
          const paymentWs = XLSX.utils.aoa_to_sheet(this.grids.payment.getData());
          XLSX.utils.book_append_sheet(wb, paymentWs, '入金情報');
          
          const expenseWs = XLSX.utils.aoa_to_sheet(this.grids.expense.getData());
          XLSX.utils.book_append_sheet(wb, expenseWs, '支払情報');
          
          const summaryWs = XLSX.utils.aoa_to_sheet(this.grids.summary.getData());
          XLSX.utils.book_append_sheet(wb, summaryWs, '収支情報');
          
          // ファイル名を生成
          const basicData = this.grids.basic.getData();
          let karteNo = '';
          if (basicData && basicData.length > 0 && basicData[0].length > 1) {
            karteNo = basicData[0][1] || '';
          }
          
          const today = new Date();
          const dateStr = today.getFullYear() +
                         ('0' + (today.getMonth() + 1)).slice(-2) +
                         ('0' + today.getDate()).slice(-2);
          const filename = `${karteNo || 'カルテ'}_${dateStr}.xlsx`;
          
          // ファイルとして保存
          XLSX.writeFile(wb, filename);
          
          this.showNotification('Excelファイルを出力しました', 'success');
        } catch (error) {
          console.error('エクスポートエラー:', error);
          this.showNotification('エクスポートに失敗しました: ' + error.message, 'error');
        }
      },
      
      // 通知を表示
      showNotification: function(message, type = 'info') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        
        // タイプに応じたスタイル
        switch (type) {
          case 'success':
            notification.style.backgroundColor = '#4CAF50';
            break;
          case 'error':
            notification.style.backgroundColor = '#f44336';
            break;
          case 'warning':
            notification.style.backgroundColor = '#ff9800';
            break;
          default:
            notification.style.backgroundColor = '#2196F3';
        }
        
        // 表示
        notification.style.display = 'block';
        
        // 3秒後に消す
        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      },
      
      // カルテを読み込む
      loadKarte: function(id) {
        // 変更があれば確認
        if (this.hasChanges) {
          if (!confirm('保存されていない変更があります。別のカルテを開きますか？')) {
            return;
          }
        }
        
        document.getElementById('last-saved').textContent = '読み込み中...';
        
        db.collection('karte').doc(id).get()
          .then(doc => {
            if (doc.exists) {
              const data = doc.data();
              
              // データを各グリッドにロード
              if (data.basicData) this.grids.basic.loadData(data.basicData);
              if (data.paymentData) this.grids.payment.loadData(data.paymentData);
              if (data.expenseData) this.grids.expense.loadData(data.expenseData);
              if (data.summaryData) this.grids.summary.loadData(data.summaryData);
              
              // 現在のIDを保存
              this.currentId = id;
              
              // カルテNoを表示
              const karteInfo = data.karteInfo || {};
              document.getElementById('current-karte-id').textContent = karteInfo.karteNo || id;
              
              // 最終更新日時を表示
              if (data.lastUpdated) {
                const lastUpdated = data.lastUpdated.toDate();
                document.getElementById('last-saved').textContent = lastUpdated.toLocaleString();
              } else {
                document.getElementById('last-saved').textContent = '-';
              }
              
              // 変更フラグをリセット
              this.hasChanges = false;
              
              // 高さを調整
              setTimeout(() => {
                this.adjustTableHeights();
              }, 100);
              
              // 通知
              this.showNotification('カルテを読み込みました', 'success');
            } else {
              this.showNotification('カルテが見つかりません', 'error');
              document.getElementById('last-saved').textContent = '-';
            }
          })
          .catch(error => {
            console.error('カルテ読み込みエラー:', error);
            document.getElementById('last-saved').textContent = '読み込み失敗';
            this.showNotification('カルテの読み込みに失敗しました', 'error');
          });
      },
      
      // カルテを削除
      deleteKarte: function(id) {
        db.collection('karte').doc(id).delete()
          .then(() => {
            this.showNotification('カルテを削除しました', 'success');
            
            // カルテリストを再読み込み
            this.loadKarteList();
            
            // 現在表示中のカルテが削除された場合は新規作成
            if (this.currentId === id) {
              this.createNew();
            }
          })
          .catch(error => {
            console.error('削除エラー:', error);
            this.showNotification('削除に失敗しました: ' + error.message, 'error');
          });
      }, 1000);
    }
    
    // カルテアプリケーション
    const KarteApp = {
      // 現在のカルテID
      currentId: null,
      
      // データに変更があるかのフラグ
      hasChanges: false,
      
      // 各グリッドインスタンス
      grids: {
        basic: null,
        payment: null,
        expense: null,
        summary: null
      },
      
      // 各テンプレート
      templates: {
        // 基本情報テンプレートを修正
        basic: [
          ['カルテNo', '', '自社担当者', '', '記入日', '', '個人通No', ''],
          ['お客様担当者', '', '団体名', '', 'お客様電話番号', ''],
          ['宿泊日', '', '泊数', '', '合計人数', ''],
          ['大人男性', '', '大人女性', '', '子供(小学生)', '', '幼児', ''],
          ['成約日', '', '利用年度', '', '', ''],
          ['出発地', '', '行先', '', '', '']
        ],
        
        // 入金情報テンプレート
        payment: [
          ['入金予定日', '入金場所', '入金予定額', '入金日', '入金額', '備考', 'チェック'],
          ['', '', '', '', '', '', ''],
          ['', '', '', '', '', '', ''],
          ['A 入金合計', '', '', '', 0, '', '']
        ],
        
        // 支払情報テンプレート
        expense: [
          ['利用日', '手配先名（該当に〇を付ける）', '電話/FAX', '担当者', '支払予定日', '支払金額', 'チェック', '手配完了'],
          ['', '', '', '', '', '', '', ''],
          ['', '', '', '', '', '', '', ''],
          ['B 支払合計', '', '', '', '', 0, '', '']
        ],
        
        // 収支情報テンプレート
        summary: [
          ['報告日', '', '利益率', '', '利益額', ''],
          ['一人粗利', '', '旅行総額/A', '', '支払総額/B', ''],
          ['人数', '', '特補人数', '', '', '']
        ]
      },
      
      // 初期化
      init: function() {
        // 各グリッドを初期化
        this.initGrids();
        
        // イベントリスナーを設定
        this.setupEventListeners();
        
        // 新規カルテを作成
        this.createNew();
        
        // 高さを調整（少し遅延して全要素が描画された後に実行）
        setTimeout(() => {
          this.adjustTableHeights();
        }, 500);
      },
      
      // 各グリッドを初期化
      initGrids: function() {
        // 基本情報グリッド
        this.grids.basic = new Handsontable(document.getElementById('basic-grid'), {
          data: this.deepCopy(this.templates.basic),
          rowHeaders: false,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minCols: 8, // 修正：列数を8に変更
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100, // すべての行を描画できるよう大きな値を設定
          renderAllRows: true,         // すべての行を一度に描画
          
          // スクロールを無効化
          overflow: 'visible',
          
          // 高さの自動調整を行う設定
          afterRender: function() {
            try {
              const tableHeight = this.rootElement.querySelector('.htCore').offsetHeight;
              this.rootElement.style.height = tableHeight + 'px';
            } catch (e) {
              console.warn('テーブル高さ調整エラー:', e);
            }
          },
          
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              this.markHasChanges();
            }
          }
        });
        
        // 入金情報グリッド
        this.grids.payment = new Handsontable(document.getElementById('payment-grid'), {
          data: this.deepCopy(this.templates.payment),
          rowHeaders: true,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minRows: 4,
          contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100, // すべての行を描画できるよう大きな値を設定
          renderAllRows: true,         // すべての行を一度に描画
          
          // スクロールを無効化
          overflow: 'visible',
          
          // 高さの自動調整を行う設定
          afterRender: function() {
            try {
              const tableHeight = this.rootElement.querySelector('.htCore').offsetHeight;
              this.rootElement.style.height = tableHeight + 'px';
            } catch (e) {
              console.warn('テーブル高さ調整エラー:', e);
            }
          },
          
          cells: (row, col) => {
            const cellProperties = {};
            // 入金予定額、入金額列は数値型
            if ((col === 2 || col === 4) && row > 0) {
              cellProperties.type = 'numeric';
              cellProperties.numericFormat = {
                pattern: '0,0',
                culture: 'ja-JP'
              };
            }
            // チェック列はチェックボックス
            if (col === 6 && row > 0 && row < this.getRowCount('payment') - 1) {
              cellProperties.type = 'checkbox';
            }
            // 合計行は読み取り専用
            if (row === this.getRowCount('payment') - 1) {
              cellProperties.readOnly = true;
              if (col === 0) {
                cellProperties.className = 'total-cell';
              }
            }
            return cellProperties;
          },
          
          // データ変更時の処理
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              this.calculatePaymentTotal();
              this.markHasChanges();
            }
          },
          
          // 行追加・削除時の処理
          afterCreateRow: (index, amount, source) => {
            try {
              // 合計行が常に最後になるように調整
              const rowCount = this.grids.payment.countRows();
              const data = this.grids.payment.getData();
              
              // 合計行が最後の行でない場合は移動
              if (!data[rowCount-1][0] || !data[rowCount-1][0].startsWith('A ')) {
                // 合計行を探す
                for (let i = 0; i < rowCount; i++) {
                  if (data[i][0] && String(data[i][0]).startsWith('A ')) {
                    // 合計行を削除して最後に追加
                    const totalRow = data[i].slice();
                    this.grids.payment.alter('remove_row', i, 1);
                    this.grids.payment.alter('insert_row', rowCount-1, 1);
                    this.grids.payment.setDataAtRow(rowCount-1, totalRow);
                    break;
                  }
                }
              }
              
              this.calculatePaymentTotal();
              this.markHasChanges();
              
              // 高さを再調整
              setTimeout(() => {
                this.adjustTableHeights();
              }, 100);
            } catch (error) {
              console.error('行追加処理エラー:', error);
            }
          },
          
          afterRemoveRow: (index, amount) => {
            this.calculatePaymentTotal();
            this.markHasChanges();
            
            // 高さを再調整
            setTimeout(() => {
              this.adjustTableHeights();
            }, 100);
          }
        });
        
        // 支払情報グリッド
        this.grids.expense = new Handsontable(document.getElementById('expense-grid'), {
          data: this.deepCopy(this.templates.expense),
          rowHeaders: true,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minRows: 4,
          contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100, // すべての行を描画できるよう大きな値を設定
          renderAllRows: true,         // すべての行を一度に描画
          
          // スクロールを無効化
          overflow: 'visible',
          
          // 高さの自動調整を行う設定
          afterRender: function() {
            try {
              const tableHeight = this.rootElement.querySelector('.htCore').offsetHeight;
              this.rootElement.style.height = tableHeight + 'px';
            } catch (e) {
              console.warn('テーブル高さ調整エラー:', e);
            }
          },
          
          cells: (row, col) => {
            const cellProperties = {};
            // 支払金額列は数値型
            if (col === 5 && row > 0) {
              cellProperties.type = 'numeric';
              cellProperties.numericFormat = {
                pattern: '0,0',
                culture: 'ja-JP'
              };
            }
            // チェック列と手配完了列はチェックボックス
            if ((col === 6 || col === 7) && row > 0 && row < this.getRowCount('expense') - 1) {
              cellProperties.type = 'checkbox';
            }
            // 合計行は読み取り専用
            if (row === this.getRowCount('expense') - 1) {
              cellProperties.readOnly = true;
              if (col === 0) {
                cellProperties.className = 'total-cell';
              }
            }
            return cellProperties;
          },
          
          // データ変更時の処理
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              this.calculateExpenseTotal();
              this.markHasChanges();
            }
          },
          
          // 行追加・削除時の処理
          afterCreateRow: (index, amount, source) => {
            try {
              // 合計行が常に最後になるように調整
              const rowCount = this.grids.expense.countRows();
              const data = this.grids.expense.getData();
              
              // 合計行が最後の行でない場合は移動
              if (!data[rowCount-1][0] || !data[rowCount-1][0].startsWith('B ')) {
                // 合計行を探す
                for (let i = 0; i < rowCount; i++) {
                  if (data[i][0] && String(data[i][0]).startsWith('B ')) {
                    // 合計行を削除して最後に追加
                    const totalRow = data[i].slice();
                    this.grids.expense.alter('remove_row', i, 1);
                    this.grids.expense.alter('insert_row', rowCount-1, 1);
                    this.grids.expense.setDataAtRow(rowCount-1, totalRow);
                    break;
                  }
                }
              }
              
              this.calculateExpenseTotal();
              this.markHasChanges();
              
              // 高さを再調整
              setTimeout(() => {
                this.adjustTableHeights();
              }, 100);
            } catch (error) {
              console.error('行追加処理エラー:', error);
            }
          },
          
          afterRemoveRow: (index, amount) => {
            this.calculateExpenseTotal();
            this.markHasChanges();
            
            // 高さを再調整
            setTimeout(() => {
              this.adjustTableHeights();
            }, 100);
          }
        });
        
        // 収支情報グリッド
        this.grids.summary = new Handsontable(document.getElementById('summary-grid'), {
          data: this.deepCopy(this.templates.summary),
          rowHeaders: false,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100, // すべての行を描画できるよう大きな値を設定
          renderAllRows: true,         // すべての行を一度に描画
          
          // スクロールを無効化
          overflow: 'visible',
          
          // 高さの自動調整を行う設定
          afterRender: function() {
            try {
              const tableHeight = this.rootElement.querySelector('.htCore').offsetHeight;
              this.rootElement.style.height = tableHeight + 'px';
            } catch (e) {
              console.warn('テーブル高さ調整エラー:', e);
            }
          },
          
          cells: (row, col) => {
            const cellProperties = {};
            // 数値セルの設定
            if (col === 1 || col === 3 || col === 5) {
              // 報告日以外の値列は数値型
              if (!(row === 0 && col === 1)) {
                cellProperties.type = 'numeric';
                cellProperties.numericFormat = {
                  pattern: '0,0',
                  culture: 'ja-JP'
                };
              }
              
              // 読み取り専用セル
              if (
                (row === 0 && col === 3) || // 利益率
                (row === 0 && col === 5) || // 利益額
                (row === 1 && col === 1) || // 一人粗利
                (row === 1 && col === 3) || // 旅行総額/A
                (row === 1 && col === 5)    // 支払総額/B
              ) {
                cellProperties.readOnly = true;
              }
            }
            
            // 報告日は日付型
            if (row === 0 && col === 1) {
              cellProperties.type = 'date';
              cellProperties.dateFormat = 'YYYY/MM/DD';
            }
            
            return cellProperties;
          },
          
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              this.markHasChanges();
              this.calculateProfit();
            }
          }
        });
      },
      
      // イベントリスナーの設定
      setupEventListeners: function() {
        // 保存ボタン
        document.getElementById('save-btn').addEventListener('click', () => {
          this.saveKarte();
        });
        
        // 新規ボタン
        document.getElementById('new-btn').addEventListener('click', () => {
          // 変更があれば確認
          if (this.hasChanges) {
            if (!confirm('保存されていない変更があります。新規カルテを作成しますか？')) {
              return;
            }
          }
          this.createNew();
        });
        
        // 開くボタン
        document.getElementById('open-btn').addEventListener('click', () => {
          this.loadKarteList();
        });
        
        // エクスポートボタン
        document.getElementById('export-btn').addEventListener('click', () => {
          this.exportToExcel();
        });
        
        // 入金情報に行を追加するボタン
        document.getElementById('add-payment-row').addEventListener('click', () => {
          const rowCount = this.grids.payment.countRows();
          const lastRowIndex = rowCount - 1;
          
          try {
            // 合計行の前に新しい行を追加
            this.grids.payment.alter('insert_row', lastRowIndex, 1);
            
            // 高さを再調整
            setTimeout(() => {
              this.adjustTableHeights();
            }, 100);
          } catch (error) {
            console.error('行追加処理エラー:', error);
            
            try {
              // 別の方法を試す: データを直接操作
              const currentData = this.grids.payment.getData();
              const totalRow = currentData[lastRowIndex].slice();
              
              // 合計行を削除して新しい行を追加し、再度合計行を追加
              currentData.splice(lastRowIndex, 1);
              currentData.push(Array(totalRow.length).fill(''));
              currentData.push(totalRow);
              
              this.grids.payment.loadData(currentData);
              
              // 高さを再調整
              setTimeout(() => {
                this.adjustTableHeights();
              }, 100);
            } catch (innerError) {
              console.error('代替行追加方法も失敗:', innerError);
              this.showNotification('行の追加に失敗しました', 'error');
            }
          }
        });
        
        // 支払情報に行を追加するボタン
        document.getElementById('add-expense-row').addEventListener('click', () => {
          const rowCount = this.grids.expense.countRows();
          const lastRowIndex = rowCount - 1;
          
          try {
            // 合計行の前に新しい行を追加
            this.grids.expense.alter('insert_row', lastRowIndex, 1);
            
            // 高さを再調整
            setTimeout(() => {
              this.adjustTableHeights();
            }, 100);
          } catch (error) {
            console.error('行追加処理エラー:', error);
            
            try {
              // 別の方法を試す: データを直接操作
              const currentData = this.grids.expense.getData();
              const totalRow = currentData[lastRowIndex].slice();
              
              // 合計行を削除して新しい行を追加し、再度合計行を追加
              currentData.splice(lastRowIndex, 1);
              currentData.push(Array(totalRow.length).fill(''));
              currentData.push(totalRow);
              
              this.grids.expense.loadData(currentData);
              
              // 高さを再調整
              setTimeout(() => {
                this.adjustTableHeights();
              }, 100);
            } catch (innerError) {
              console.error('代替行追加方法も失敗:', innerError);
              this.showNotification('行の追加に失敗しました', 'error');
            }
          }
        });
        
        // モーダル関連
        document.querySelector('.close').addEventListener('click', () => {
          document.getElementById('list-modal').style.display = 'none';
        });
        
        // 検索フィールド
        document.getElementById('search').addEventListener('input', (e) => {
          this.filterKarteList(e.target.value);
        });
        
        // ウィンドウクリックでモーダルを閉じる
        window.addEventListener('click', (event) => {
          if (event.target === document.getElementById('list-modal')) {
            document.getElementById('list-modal').style.display = 'none';
          }
        });
        
        // 接続状態の監視
        window.addEventListener('online', () => {
          document.getElementById('connection-status').textContent = 'オンライン';
          document.getElementById('connection-status').style.color = '';
          this.showNotification('ネットワーク接続が復旧しました', 'success');
        });
        
        window.addEventListener('offline', () => {
          document.getElementById('connection-status').textContent = 'オフライン';
          document.getElementById('connection-status').style.color = 'red';
          this.showNotification('オフライン状態になりました', 'warning');
        });
        
        // ウィンドウサイズ変更時に高さを調整
        window.addEventListener('resize', () => {
          // デバウンス処理
          clearTimeout(this.resizeTimer);
          this.resizeTimer = setTimeout(() => {
            this.adjustTableHeights();
          }, 200);
        });
        
        // ページを離れる前に変更を確認
        window.addEventListener('beforeunload', (e) => {
          if (this.hasChanges) {
            e.preventDefault();
            e.returnValue = '保存されていない変更があります。ページを離れますか？';
            return e.returnValue;
          }
        });
      },
      
      // 新規カルテを作成
      createNew: function() {
        this.currentId = null;
        document.getElementById('current-karte-id').textContent = '新規カルテ';
        document.getElementById('last-saved').textContent = '-';
        
        // 各グリッドにテンプレートデータをロード
        this.grids.basic.loadData(this.deepCopy(this.templates.basic));
        this.grids.payment.loadData(this.deepCopy(this.templates.payment));
        this.grids.expense.loadData(this.deepCopy(this.templates.expense));
        this.grids.summary.loadData(this.deepCopy(this.templates.summary));
        
        // 現在の日付を報告日と記入日に設定
        const today = new Date();
        const formattedDate = today.getFullYear() + "/" + 
                             ('0' + (today.getMonth() + 1)).slice(-2) + "/" + 
                             ('0' + today.getDate()).slice(-2);
        
        // 報告日にセット
        this.grids.summary.setDataAtCell(0, 1, formattedDate, 'internal');
        
        // 記入日にも同じ日付をセット
        this.grids.basic.setDataAtCell(0, 5, formattedDate, 'internal');
        
        // 変更フラグをリセット
        this.hasChanges = false;
        
        // 高さを調整
        setTimeout(() => {
          this.adjustTableHeights();
        }, 100);
      },
      
      // 入金合計を計算
      calculatePaymentTotal: function() {
        if (!this.grids.payment) return;
        
        try {
          const data = this.grids.payment.getData();
          let total = 0;
          const lastRowIndex = data.length - 1;
          
          // 合計行以外の入金額を合計
          for (let i = 1; i < lastRowIndex; i++) {
            const value = this.parseNumber(data[i][4]); // 入金額列
            if (!isNaN(value)) {
              total += value;
            }
          }
          
          // 合計を表示
          this.grids.payment.setDataAtCell(lastRowIndex, 4, total, 'internal');
          
          // 収支情報に反映
          if (this.grids.summary) {
            this.grids.summary.setDataAtCell(1, 3, total, 'internal'); // 旅行総額/A
            this.calculateProfit();
          }
        } catch (error) {
          console.error('入金合計計算エラー:', error);
        }
      },
      
      // 支払合計を計算
      calculateExpenseTotal: function() {
        if (!this.grids.expense) return;
        
        try {
          const data = this.grids.expense.getData();
          let total = 0;
          const lastRowIndex = data.length - 1;
          
          // 合計行以外の支払金額を合計
          for (let i = 1; i < lastRowIndex; i++) {
            const value = this.parseNumber(data[i][5]); // 支払金額列
            if (!isNaN(value)) {
              total += value;
            }
          }
          
          // 合計を表示
          this.grids.expense.setDataAtCell(lastRowIndex, 5, total, 'internal');
          
          // 収支情報に反映
          if (this.grids.summary) {
            this.grids.summary.setDataAtCell(1, 5, total, 'internal'); // 支払総額/B
            this.calculateProfit();
          }
        } catch (error) {
          console.error('支払合計計算エラー:', error);
        }
      },
      
      // 利益を計算
      calculateProfit: function() {
        if (!this.grids.summary) return;
        
        try {
          const data = this.grids.summary.getData();
          const income = this.parseNumber(data[1][3]); // 旅行総額/A
          const expense = this.parseNumber(data[1][5]); // 支払総額/B
          
          // 利益額を計算
          const profit = income - expense;
          this.grids.summary.setDataAtCell(0, 5, profit, 'internal');
          
          // 基本情報から人数を取得 - 合計人数
          const basicData = this.grids.basic.getData();
          let personCount = 0;
          
          if (basicData && basicData.length > 2 && basicData[2].length > 5) {
            personCount = this.parseNumber(basicData[2][5]);
          }
          
          // 収支データの人数も更新
          this.grids.summary.setDataAtCell(2, 1, personCount, 'internal');
          
          // 利益率を計算
          let profitRate = 0;
          if (income > 0) {
            profitRate = (profit / income * 100).toFixed(1) + '%';
          }
          this.grids.summary.setDataAtCell(0, 3, profitRate, 'internal');
          
          // 一人粗利を計算
          let profitPerPerson = 0;
          if (personCount > 0) {
            profitPerPerson = Math.round(profit / personCount);
          }
          this.grids.summary.setDataAtCell(1, 1, profitPerPerson, 'internal');
        } catch (error) {
          console.error('利益計算エラー:', error);
        }
      },
      
      // Firebaseに保存できる形式にデータを変換するヘルパーメソッド
      prepareDataForFirebase: function(data) {
        if (!data || !Array.isArray(data)) {
          return [];
        }
        
        try {
          // データを深くコピーして変更
          const processedData = JSON.parse(JSON.stringify(data));
          
          // 配列の各要素を処理
          return processedData.map(row => {
            // 各行も配列であることを確認
            if (Array.isArray(row)) {
              // 各セルの内容を適切に変換
              return row.map(cell => {
                // nullやundefinedを空文字に変換
                if (cell === null || cell === undefined) {
                  return '';
                }
                
                // オブジェクトや配列をJSON文字列に変換
                if (typeof cell === 'object') {
                  return JSON.stringify(cell);
                }
                
                // それ以外はそのまま返す
                return cell;
              });
            } else {
              // 行が配列でない場合は空の配列を返す
              console.warn('行が配列ではありません:', row);
              return [];
            }
          });
        } catch (error) {
          console.error('Firebase用データ変換エラー:', error);
          return [];
        }
      },
      
      // 基本情報からカルテ情報を抽出するヘルパーメソッド
      extractKarteInfo: function(basicData) {
        const karteInfo = {};
        
        try {
          // 基本的な情報を抽出（新しいレイアウトに合わせて変更）
          if (basicData && basicData.length >= 6) {
            // カルテNo
            if (basicData[0] && basicData[0].length >= 2) {
              karteInfo.karteNo = basicData[0][1] || '';
            }
            
            // お客様担当者
            if (basicData[1] && basicData[1].length >= 2) {
              karteInfo.tantosha = basicData[1][1] || '';
            }
            
            // 自社担当者
            if (basicData[0] && basicData[0].length >= 4) {
              karteInfo.companyTantosha = basicData[0][3] || '';
            }
            
            // 団体名
            if (basicData[1] && basicData[1].length >= 4) {
              karteInfo.dantaiName = basicData[1][3] || '';
            }
            
            // お客様電話番号
            if (basicData[1] && basicData[1].length >= 6) {
              karteInfo.phoneNumber = basicData[1][5] || '';
            }
            
            // 宿泊日
            if (basicData[2] && basicData[2].length >= 2) {
              karteInfo.stayDate = basicData[2][1] || '';
            }
            
            // 泊数
            if (basicData[2] && basicData[2].length >= 4) {
              karteInfo.nights = basicData[2][3] || '';
            }
            
            // 合計人数
            if (basicData[2] && basicData[2].length >= 6) {
              karteInfo.personCount = basicData[2][5] || '';
            }
            
            // 出発地
            if (basicData[5] && basicData[5].length >= 2) {
              karteInfo.departure = basicData[5][1] || '';
            }
            
            // 行先
            if (basicData[5] && basicData[5].length >= 4) {
              karteInfo.destination = basicData[5][3] || '';
            }
          }
        } catch (e) {
          console.error('カルテ情報抽出エラー:', e);
        }
        
        return karteInfo;
      },
      
      // カルテを保存
      saveKarte: function() {
        // オフライン確認
        if (!navigator.onLine) {
          this.showNotification('オフライン状態では保存できません', 'error');
          return;
        }
        
        // 保存中表示
        document.getElementById('last-saved').textContent = '保存中...';
        
        try {
          // 各グリッドのデータを取得して Firebase 互換形式に変換
          const basicData = this.grids.basic ? this.prepareDataForFirebase(this.grids.basic.getData()) : [];
          const paymentData = this.grids.payment ? this.prepareDataForFirebase(this.grids.payment.getData()) : [];
          const expenseData = this.grids.expense ? this.prepareDataForFirebase(this.grids.expense.getData()) : [];
          const summaryData = this.grids.summary ? this.prepareDataForFirebase(this.grids.summary.getData()) : [];
          
          // カルテデータを収集
          const karteData = {
            basicData: basicData,
            paymentData: paymentData,
            expenseData: expenseData,
            summaryData: summaryData,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // 基本情報から識別データを抽出
          const karteInfo = this.extractKarteInfo(basicData);
          karteData.karteInfo = karteInfo;
          
          console.log('保存するデータ準備完了');
          
          // 保存処理
          let savePromise;
          
          if (this.currentId) {
            // 既存のカルテを更新
            savePromise = db.collection('karte').doc(this.currentId).update(karteData);
          } else {
            // 新規カルテを作成
            savePromise = db.collection('karte').add(karteData)
              .then(docRef => {
                this.currentId = docRef.id;
                return docRef;
              });
          }
          
          savePromise
            .then(() => {
              const now = new Date();
              document.getElementById('last-saved').textContent = now.toLocaleString();
              
              // カルテIDを表示
              document.getElementById('current-karte-id').textContent = karteInfo.karteNo || this.currentId;
              
              // 変更フラグをリセット
              this.hasChanges = false;
              
              // 保存成功通知
              this.showNotification('カルテを保存しました', 'success');
            })
            .catch(error => {
              console.error('保存エラー:', error);
              document.getElementById('last-saved').textContent = '保存失敗';
              this.showNotification('保存に失敗しました: ' + error.message, 'error');
            });
        } catch (error) {
          console.error('データ準備エラー:', error);
          document.getElementById('last-saved').textContent = '保存失敗';
          this.showNotification('データの準備中にエラーが発生しました', 'error');
        }
      },
      
      // カルテリストを読み込む
      loadKarteList: function() {
        // 変更があれば確認
        if (this.hasChanges) {
          if (!confirm('保存されていない変更があります。カルテ一覧を開きますか？')) {
            return;
          }
        }
        
        const listBody = document.querySelector('#karte-list tbody');
        listBody.innerHTML = '<tr><td colspan="7">読み込み中...</td></tr>';
        
        document.getElementById('list-modal').style.display = 'block';
        
        // 検索フィールドをクリア
        document.getElementById('search').value = '';
        
        db.collection('karte').orderBy('lastUpdated', 'desc').limit(50).get()
          .then(querySnapshot => {
            if (querySnapshot.empty) {
              listBody.innerHTML = '<tr><td colspan="7">カルテがありません</td></tr>';
              return;
            }
            
            // データ行
            let html = '';
            querySnapshot.forEach(doc => {
              const data = doc.data();
              const info = data.karteInfo || {};
              
              html += `
                <tr data-id="${doc.id}">
                  <td>${info.karteNo || '-'}</td>
                  <td>${info.tantosha || '-'}</td>
                  <td>${info.dantaiName || '-'}</td>
                  <td>${info.stayDate || '-'}</td>
                  <td>${info.personCount || '-'}</td>
                  <td>${info.destination || '-'}</td>
                  <td>
                    <button class="edit-btn" data-id="${doc.id}">編集</button>
                    <button class="delete-btn" data-id="${doc.id}">削除</button>
                  </td>
                </tr>
              `;
            });
            
            listBody.innerHTML = html;
            
            // 編集ボタンのイベント設定
            document.querySelectorAll('.edit-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                this.loadKarte(id);
                document.getElementById('list-modal').style.display = 'none';
              });
            });
            
            // 削除ボタンのイベント設定
            document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                if (confirm('このカルテを削除してもよろしいですか？')) {
                  this.deleteKarte(id);
                }
              });
            });
          })
          .catch(error => {
            console.error('カルテリスト取得エラー:', error);
            listBody.innerHTML = `<tr><td colspan="7">エラー: ${error.message}</td></tr>`;
            this.showNotification('カルテ一覧の取得に失敗しました', 'error');
          });
      },
      
      // カルテ一覧をフィルタリング
      filterKarteList: function(searchText) {
        const rows = document.querySelectorAll('#karte-list tbody tr');
        searchText = searchText.toLowerCase();
        
        let foundCount = 0;
        
        rows.forEach(row => {
          if (row.querySelector('td[colspan]')) return; // メッセージ行はスキップ
          
          let found = false;
          const cells = row.querySelectorAll('td:not(:last-child)');
          
          cells.forEach(cell => {
            if (cell.textContent.toLowerCase().includes(searchText)) {
              found = true;
            }
          });
          
          row.style.display = found ? '' : 'none';
          if (found) foundCount++;
        });
        
        // 結果がない場合
        if (foundCount === 0 && searchText) {
          const listBody = document.querySelector('#karte-list tbody');
          // 既存の「結果なし」行があれば削除
          const noResultRow = document.getElementById('no-results-row');
          if (noResultRow) noResultRow.remove();
          
          // 結果なし行を追加
          if (rows.length > 0) {
            const message = document.createElement('tr');
            message.id = 'no-results-row';
            message.innerHTML = `<td colspan="7" style="text-align: center;">「${searchText}」に一致するカルテはありません</td>`;
            listBody.appendChild(message);
          }
        } else {
          // 既存の「結果なし」行があれば削除
          const noResultRow = document.getElementById('no-results-row');
          if (noResultRow) noResultRow.remove();
        }
      },
