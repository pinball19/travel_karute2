<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>団体ナビ成約カルテ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css" />
  <style>
    /* 既存スタイル（変更なし） */
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
    .app-container { max-width: 1200px; margin: 0 auto; background-color: white; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; border-radius: 5px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    .app-title h1 { margin: 0; color: #217346; }
    .app-info { font-size: 14px; color: #666; }
    .action-buttons { display: flex; gap: 10px; margin-bottom: 20px; }
    button { padding: 8px 16px; background-color: #217346; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background-color: #1a5e38; }
    .section-container { margin-bottom: 25px; border: 1px solid #ddd; border-radius: 5px; overflow: hidden; }
    .section-header { padding: 8px 15px; font-weight: bold; font-size: 16px; color: white; }
    .grid-container { height: auto !important; overflow: visible !important; }
    footer { margin-top: 30px; padding-top: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; font-size: 14px; color: #666; }
    .basic-section .section-header { background-color: #4472c4; }
    .payment-section .section-header { background-color: #70ad47; }
    .expense-section .section-header { background-color: #ed7d31; }
    .summary-section .section-header { background-color: #7030a0; }
    .add-row-btn { margin: 5px 10px 10px 0; padding: 5px 10px; background-color: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer; float: right; }
    .add-row-btn:hover { background-color: #45a049; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; }
    .modal-content { position: relative; background-color: white; margin: 50px auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 5px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .close { position: absolute; top: 10px; right: 15px; font-size: 24px; font-weight: bold; cursor: pointer; }
    .notification { position: fixed; bottom: 20px; right: 20px; padding: 10px 20px; background-color: #4caf50; color: white; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 9999; display: none; }
    .handsontable .wtHolder, .handsontable .ht_master .wtHolder, .handsontable .wtHider { overflow: visible !important; height: auto !important; }
    .handsontable { height: auto !important; }
    .handsontable .htCore { height: auto !important; }
    .handsontable ::-webkit-scrollbar { display: none !important; }
    .handsontable { -ms-overflow-style: none !important; scrollbar-width: none !important; }
    .handsontable .wtSpreader { height: auto !important; width: auto !important; }
    .ht_clone_top { z-index: 101 !important; }
    #karte-list { width: 100%; border-collapse: collapse; margin-top: 10px; }
    #karte-list th, #karte-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    #karte-list th { background-color: #f2f2f2; }
    #karte-list tr:nth-child(even) { background-color: #f9f9f9; }
    #karte-list tr:hover { background-color: #f1f1f1; }
    .search-container { margin-bottom: 10px; }
    #search { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
    .edit-btn, .delete-btn { padding: 5px 10px; margin-right: 5px; font-size: 12px; }
    .delete-btn { background-color: #f44336; }
    .delete-btn:hover { background-color: #d32f2f; }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="app-title"><h1>団体ナビ成約カルテ</h1></div>
      <div class="app-info">
        <!-- 表示を「カルテNo」に統一 -->
        <div>カルテNo: <span id="current-karte-id">新規カルテ</span></div>
        <div>最終更新: <span id="last-saved">-</span></div>
      </div>
    </header>
    <div class="action-buttons">
      <button id="save-btn">保存</button>
      <button id="new-btn">新規</button>
      <button id="open-btn">開く</button>
      <button id="export-btn">エクスポート</button>
    </div>
    <main>
      <div class="section-container basic-section" id="basic-section">
        <div class="section-header">◆ 基本情報</div>
        <div id="basic-grid" class="grid-container"></div>
      </div>
      <div class="section-container payment-section" id="payment-section">
        <div class="section-header">◆ 入金情報</div>
        <div id="payment-grid" class="grid-container"></div>
        <button id="add-payment-row" class="add-row-btn">行を追加</button>
      </div>
      <div class="section-container expense-section" id="expense-section">
        <div class="section-header">◆ 支払情報</div>
        <div id="expense-grid" class="grid-container"></div>
        <button id="add-expense-row" class="add-row-btn">行を追加</button>
      </div>
      <div class="section-container summary-section" id="summary-section">
        <div class="section-header">◆ 収支情報</div>
        <div id="summary-grid" class="grid-container"></div>
      </div>
    </main>
    <footer>
      <div>カルテシステム v1.0</div>
      <div>接続状態: <span id="connection-status">オンライン</span></div>
    </footer>
  </div>
  <div id="list-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>カルテ一覧</h2>
      <div class="search-container">
        <input type="text" id="search" placeholder="検索..." />
      </div>
      <table id="karte-list">
        <thead>
          <tr>
            <th>カルテNo</th>
            <th>お客様担当者</th>
            <th>団体名</th>
            <th>宿泊日</th>
            <th>人数</th>
            <th>行先</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody><!-- JSで行を追加 --></tbody>
      </table>
    </div>
  </div>
  <div id="notification" class="notification"></div>
  <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // ========= Firebase設定 =========
    const firebaseConfig = {
      apiKey: "AIzaSyExample",
      authDomain: "travelkarute.firebaseapp.com",
      projectId: "travelkarute",
      storageBucket: "travelkarute.appspot.com",
      messagingSenderId: "635350270309",
      appId: "1:635350270309:web:2498d21f9f134defeda18c"
    };
    try {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      db.enablePersistence({ synchronizeTabs: true })
        .catch(err => { console.warn("Persistence error:", err); });
    } catch (error) {
      console.error("Firebase初期化エラー:", error);
      setTimeout(() => { alert("サーバー接続に問題が発生しました。ページをリロードしてください。"); }, 1000);
    }
    
    // ========= カルテアプリケーション =========
    const KarteApp = {
      currentId: null,
      hasChanges: false,
      // 個別の debounce タイマー
      paymentDebounceTimer: null,
      expenseDebounceTimer: null,
      // 自動保存用タイマー
      autoSaveTimer: null,
      grids: { basic: null, payment: null, expense: null, summary: null },
      templates: {
        basic: [
          ['カルテNo', '', '自社担当者', '', '記入日', '', '個人通No', ''],
          ['お客様担当者', '', '団体名', '', 'お客様電話番号', ''],
          ['宿泊日', '', '泊数', '', '合計人数', ''],
          ['大人男性', '', '大人女性', '', '子供(小学生)', '', '幼児', ''],
          ['成約日', '', '利用年度', '', '', ''],
          ['出発地', '', '行先', '', '', '']
        ],
        payment: [
          ['入金予定日', '入金場所', '入金予定額', '入金日', '入金額', '備考', 'チェック'],
          ['', '', '', '', '', '', ''],
          ['', '', '', '', '', '', ''],
          ['A 入金合計', '', '', '', 0, '', '']
        ],
        expense: [
          ['利用日', '手配先名（該当に〇を付ける）', '電話/FAX', '担当者', '支払予定日', '支払金額', 'チェック', '手配完了'],
          ['', '', '', '', '', '', '', ''],
          ['', '', '', '', '', '', '', ''],
          ['B 支払合計', '', '', '', '', 0, '', '']
        ],
        summary: [
          // 行0: ラベル行（変更なし）
          ["報告日", "利益率", "利益額", "一人粗利", "旅行総額/A", "支払総額/B", "人数", "特補人数"],
          // 行1: 計算結果を表示するための行
          ["", "", "", "", "", "", "", ""]
        ]
      },
      
      init: function() {
        console.log("KarteApp.init() start");
        this.initGrids();
        this.setupEventListeners();
        this.createNew();
        setTimeout(() => { this.adjustTableHeights(); }, 500);
        console.log("KarteApp.init() end");
      },
      
      initGrids: function() {
        const that = this;
        console.log("initGrids() start");
        // --- 基本情報 ---
        this.grids.basic = new Handsontable(document.getElementById('basic-grid'), {
          data: this.deepCopy(this.templates.basic),
          rowHeaders: false,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minCols: 8,
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          afterRender: function() {
            try {
              const tableHeight = this.rootElement.querySelector('.htCore').offsetHeight;
              this.rootElement.style.height = tableHeight + 'px';
              console.log("基本グリッド afterRender: tableHeight=", tableHeight);
            } catch (e) { console.warn('基本グリッド 高さ調整エラー:', e); }
          },
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') { that.markHasChanges(); }
          }
        });
        
        // --- 入金情報 ---
        this.grids.payment = new Handsontable(document.getElementById('payment-grid'), {
          data: this.deepCopy(this.templates.payment),
          rowHeaders: true,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minRows: 4,
          contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          cells: function(row, col) {
            const cellProperties = {};
            if ((col === 2 || col === 4) && row > 0) {
              cellProperties.type = 'numeric';
              cellProperties.numericFormat = { pattern: '0,0', culture: 'ja-JP' };
            }
            if (col === 6 && row > 0 && row < that.getRowCount('payment') - 1) {
              cellProperties.type = 'checkbox';
            }
            if (row === that.getRowCount('payment') - 1) {
              cellProperties.readOnly = true;
              if (col === 0) { cellProperties.className = 'total-cell'; }
            }
            return cellProperties;
          },
          afterChange: function(changes, source) {
            if (source === 'edit' || source === 'paste') {
              console.log("入金グリッド afterChange (immediate):", changes);
              console.log("入金グリッド data (immediate):", this.getData());
              // 即時更新：もし最終行（A 入金合計行）の入金額（col4）が変更されたなら、
              // Summary グリッドの旅行総額/A (Row1, Col4) に即座に反映する
              const lastRowIndex = this.countRows() - 1;
              changes.forEach(change => {
                const [row, col, oldValue, newValue] = change;
                if (row === lastRowIndex && col === 4) {
                  that.grids.summary.setDataAtCell(1, 4, newValue, 'internal');
                  console.log("即座に Summary グリッドの旅行総額/A を更新:", newValue);
                }
              });
              clearTimeout(that.paymentDebounceTimer);
              that.paymentDebounceTimer = setTimeout(() => {
                console.log("入金グリッド data (debounced):", this.getData());
                that.calculatePaymentTotal();
                that.markHasChanges();
              }, 100);
            }
          },
          afterCreateRow: function(index, amount, source) {
            try {
              const rowCount = this.countRows();
              const data = this.getData();
              console.log("入金グリッド afterCreateRow: index=", index, " amount=", amount, " rowCount=", rowCount);
              if (!data[rowCount - 1][0] || !String(data[rowCount - 1][0]).startsWith('A ')) {
                for (let i = 0; i < rowCount; i++) {
                  if (data[i][0] && String(data[i][0]).startsWith('A ')) {
                    const totalRow = data[i].slice();
                    console.log("入金グリッド: 合計行発見 at row", i);
                    this.alter('remove_row', i, 1);
                    console.log("入金グリッド: remove_row", i);
                    this.alter('insert_row', rowCount, 1);
                    console.log("入金グリッド: insert_row at index", rowCount);
                    this.setDataAtRow(rowCount, totalRow);
                    break;
                  }
                }
              }
              that.calculatePaymentTotal();
              that.markHasChanges();
              setTimeout(() => { that.adjustTableHeights(); }, 100);
            } catch (error) { console.error('入金グリッド 行追加処理エラー:', error); }
          },
          afterRemoveRow: function(index, amount) {
            console.log("入金グリッド afterRemoveRow: index=", index, " amount=", amount);
            that.calculatePaymentTotal();
            that.markHasChanges();
            setTimeout(() => { that.adjustTableHeights(); }, 100);
          }
        });
        
        // --- 支払情報 ---
        this.grids.expense = new Handsontable(document.getElementById('expense-grid'), {
          data: this.deepCopy(this.templates.expense),
          rowHeaders: true,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minRows: 4,
          contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          cells: function(row, col) {
            const cellProperties = {};
            if (col === 5 && row > 0) {
              cellProperties.type = 'numeric';
              cellProperties.numericFormat = { pattern: '0,0', culture: 'ja-JP' };
            }
            if ((col === 6 || col === 7) && row > 0 && row < that.getRowCount('expense') - 1) {
              cellProperties.type = 'checkbox';
            }
            if (row === that.getRowCount('expense') - 1) {
              cellProperties.readOnly = true;
              if (col === 0) { cellProperties.className = 'total-cell'; }
            }
            return cellProperties;
          },
          afterChange: function(changes, source) {
            if (source === 'edit' || source === 'paste') {
              console.log("支払グリッド afterChange (immediate):", changes);
              console.log("支払グリッド data (immediate):", this.getData());
              // 即時更新：もし最終行（B 支払合計行）の支払金額（col5）が変更されたなら、
              // Summary グリッドの支払総額/B (Row1, Col5) に即座に反映する
              const lastRowIndex = this.countRows() - 1;
              changes.forEach(change => {
                const [row, col, oldValue, newValue] = change;
                if (row === lastRowIndex && col === 5) {
                  that.grids.summary.setDataAtCell(1, 5, newValue, 'internal');
                  console.log("即座に Summary グリッドの支払総額/B を更新:", newValue);
                }
              });
              clearTimeout(that.expenseDebounceTimer);
              that.expenseDebounceTimer = setTimeout(() => {
                console.log("支払グリッド data (debounced):", this.getData());
                that.calculateExpenseTotal();
                that.markHasChanges();
              }, 100);
            }
          },
          afterCreateRow: function(index, amount, source) {
            try {
              const rowCount = this.countRows();
              const data = this.getData();
              console.log("支払グリッド afterCreateRow: index=", index, " amount=", amount, " rowCount=", rowCount);
              if (!data[rowCount - 1][0] || !String(data[rowCount - 1][0]).startsWith('B ')) {
                for (let i = 0; i < rowCount; i++) {
                  if (data[i][0] && String(data[i][0]).startsWith('B ')) {
                    const totalRow = data[i].slice();
                    console.log("支払グリッド: 合計行発見 at row", i);
                    this.alter('remove_row', i, 1);
                    console.log("支払グリッド: remove_row", i);
                    this.alter('insert_row', rowCount, 1);
                    console.log("支払グリッド: insert_row at index", rowCount);
                    this.setDataAtRow(rowCount, totalRow);
                    break;
                  }
                }
              }
              that.calculateExpenseTotal();
              that.markHasChanges();
              setTimeout(() => { that.adjustTableHeights(); }, 100);
            } catch (error) { console.error('支払グリッド 行追加処理エラー:', error); }
          },
          afterRemoveRow: function(index, amount) {
            console.log("支払グリッド afterRemoveRow: index=", index, " amount=", amount);
            that.calculateExpenseTotal();
            that.markHasChanges();
            setTimeout(() => { that.adjustTableHeights(); }, 100);
          }
        });
        
        // --- 収支情報 (2行×8列) ---
        this.grids.summary = new Handsontable(document.getElementById('summary-grid'), {
          data: this.deepCopy(this.templates.summary),
          rowHeaders: false,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          cells: function(row, col) {
            const cellProperties = {};
            if (row === 0) { cellProperties.readOnly = true; }
            return cellProperties;
          },
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              console.log("収支グリッド afterChange:", changes);
              that.markHasChanges();
              that.calculateProfit();
            }
          }
        });
        console.log("initGrids() end");
      },
      
      setupEventListeners: function() {
        console.log("setupEventListeners() start");
        document.getElementById('save-btn').addEventListener('click', () => { this.saveKarte(); });
        document.getElementById('new-btn').addEventListener('click', () => {
          if (this.hasChanges && !confirm('保存されていない変更があります。新規カルテを作成しますか？')) { return; }
          this.createNew();
        });
        document.getElementById('open-btn').addEventListener('click', () => { this.loadKarteList(); });
        document.getElementById('export-btn').addEventListener('click', () => { this.exportToExcel(); });
        
        // 入金情報行追加
        document.getElementById('add-payment-row').addEventListener('click', () => {
          const hot = this.grids.payment;
          const rowCount = hot.countRows();
          console.log("add-payment-row: current rowCount=", rowCount);
          try {
            hot.alter('insert_row', rowCount, 1);
            console.log("入金情報: insert_row 成功");
            setTimeout(() => { this.adjustTableHeights(); }, 100);
          } catch (error) {
            console.error('入金情報 行追加処理エラー:', error);
          }
        });
        
        // 支払情報行追加
        document.getElementById('add-expense-row').addEventListener('click', () => {
          const hot = this.grids.expense;
          const rowCount = hot.countRows();
          console.log("add-expense-row: current rowCount=", rowCount);
          try {
            hot.alter('insert_row', rowCount, 1);
            console.log("支払情報: insert_row 成功");
            setTimeout(() => { this.adjustTableHeights(); }, 100);
          } catch (error) {
            console.error('支払情報 行追加処理エラー:', error);
          }
        });
        
        // モーダル関連
        document.querySelector('.close').addEventListener('click', () => {
          document.getElementById('list-modal').style.display = 'none';
        });
        document.getElementById('search').addEventListener('input', (e) => { this.filterKarteList(e.target.value); });
        window.addEventListener('click', (event) => {
          if (event.target === document.getElementById('list-modal')) {
            document.getElementById('list-modal').style.display = 'none';
          }
        });
        
        // オンライン・オフライン
        window.addEventListener('online', () => {
          document.getElementById('connection-status').textContent = 'オンライン';
          document.getElementById('connection-status').style.color = '';
          this.showNotification('ネットワーク接続が復旧しました', 'success');
        });
        window.addEventListener('offline', () => {
          document.getElementById('connection-status').textContent = 'オフライン';
          document.getElementById('connection-status').style.color = 'red';
          this.showNotification('オフライン状態になりました', 'warning');
        });
        
        // ウィンドウリサイズ
        window.addEventListener('resize', () => {
          clearTimeout(this.resizeTimer);
          this.resizeTimer = setTimeout(() => { this.adjustTableHeights(); }, 200);
        });
        
        // ページ離脱前
        window.addEventListener('beforeunload', (e) => {
          if (this.hasChanges) {
            e.preventDefault();
            e.returnValue = '保存されていない変更があります。ページを離れますか？';
            return e.returnValue;
          }
        });
        console.log("setupEventListeners() end");
      },
      
      showNotification: function(message, type = 'info') {
        console.log("showNotification:", message, type);
        const notification = document.getElementById('notification');
        if (!notification) { console.error("通知エレメントが見つかりません"); return; }
        notification.textContent = message;
        switch (type) {
          case 'success': notification.style.backgroundColor = '#4caf50'; break;
          case 'error': notification.style.backgroundColor = '#f44336'; break;
          case 'warning': notification.style.backgroundColor = '#ff9800'; break;
          default: notification.style.backgroundColor = '#2196F3';
        }
        notification.style.display = 'block';
        setTimeout(() => { notification.style.display = 'none'; }, 3000);
      },
      
      // 自動保存機能を markHasChanges() 内で実行
      markHasChanges: function() {
        this.hasChanges = true;
        // 変更があるたびに autoSaveTimer をリセット
        clearTimeout(this.autoSaveTimer);
        // 2秒間入力がなければ自動保存
        this.autoSaveTimer = setTimeout(() => {
          console.log("自動保存実行");
          this.saveKarte();
        }, 2000);
      },
      
      getRowCount: function(gridName) {
        return this.grids[gridName] ? this.grids[gridName].countRows() : 0;
      },
      
      parseNumber: function(value) {
        if (value === null || value === undefined || value === '') return 0;
        if (typeof value === 'number') {
          return isNaN(value) ? 0 : value;
        }
        // 全角数字を半角に変換
        const toHalf = String(value).replace(/[０-９]/g, function(s) {
          return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        });
        // カンマなどを除去
        const cleanValue = toHalf.replace(/[^\d.-]/g, '');
        const number = parseFloat(cleanValue);
        return isNaN(number) ? 0 : number;
      },
      
      deepCopy: function(obj) {
        return JSON.parse(JSON.stringify(obj));
      },
      
      adjustTableHeights: function() {
        ['basic', 'payment', 'expense', 'summary'].forEach(gridName => {
          const grid = this.grids[gridName];
          if (grid) {
            try {
              grid.render();
              const table = grid.rootElement.querySelector('.htCore');
              if (table) {
                const tableHeight = table.offsetHeight;
                grid.rootElement.style.height = tableHeight + 'px';
                const container = grid.rootElement.closest('.grid-container');
                if (container) { container.style.height = 'auto'; }
                const wtHolder = grid.rootElement.querySelector('.wtHolder');
                if (wtHolder) { wtHolder.style.height = 'auto'; }
                const wtSpreader = grid.rootElement.querySelector('.wtSpreader');
                if (wtSpreader) { wtSpreader.style.height = 'auto'; }
                console.log(`${gridName} の高さ調整: tableHeight=${tableHeight}`);
              }
            } catch (e) {
              console.error(`${gridName} の高さ調整エラー:`, e);
            }
          }
        });
      }
    };

    document.addEventListener('DOMContentLoaded', () => {
      KarteApp.init();
    });
  </script>
</body>
</html>