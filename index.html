<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>団体ナビ成約カルテ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css" />
  <style>
    /* 基本スタイル */
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
      border-radius: 5px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .app-title h1 {
      margin: 0;
      color: #217346;
    }
    .app-info {
      font-size: 14px;
      color: #666;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      padding: 8px 16px;
      background-color: #217346;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1a5e38;
    }
    .section-container {
      margin-bottom: 25px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    .section-header {
      padding: 8px 15px;
      font-weight: bold;
      font-size: 16px;
      color: white;
    }
    
    /* 新しいフォームスタイル */
    .form-section {
      padding: 15px;
    }
    .form-row {
      margin-bottom: 15px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }
    .form-label {
      width: 200px;
      font-weight: bold;
      padding-right: 15px;
    }
    .form-field {
      flex: 1;
      min-width: 250px;
    }
    .form-field input, 
    .form-field select, 
    .form-field textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-field textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    /* セクションの色分け */
    .basic-section .section-header { background-color: #4472c4; }
    .payment-section .section-header { background-color: #70ad47; }
    .expense-section .section-header { background-color: #ed7d31; }
    .summary-section .section-header { background-color: #7030a0; }
    .memo-section .section-header { background-color: #5b9bd5; }
    .comments-section .section-header { background-color: #4bacc6; }
    
    /* 追加ボタン */
    .add-item-btn {
      margin: 5px 0 15px 0;
      padding: 5px 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: block;
    }
    .add-item-btn:hover { background-color: #45a049; }
    
    /* 情報カード（入金/支払情報用） */
    .info-card {
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f9f9f9;
      position: relative;
    }
    .info-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-weight: bold;
    }
    .info-card-body {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .info-card-item {
      flex: 1;
      min-width: 120px;
    }
    .info-card-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 2px;
    }
    .info-card-value {
      font-size: 14px;
    }
    .remove-card-btn {
      background-color: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 12px;
      cursor: pointer;
    }
    .remove-card-btn:hover {
      background-color: #d32f2f;
    }
    
    /* コメント欄 */
    .comment-input {
      display: flex;
      margin-bottom: 15px;
    }
    .comment-input textarea {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-height: 60px;
      margin-right: 10px;
    }
    .comment-input button {
      align-self: flex-end;
    }
    .comment-thread {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 5px;
    }
    .comment-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      margin-bottom: 10px;
    }
    .comment-meta {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .comment-text {
      margin-left: 10px;
    }
    
    /* モーダル */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background-color: white;
      margin: 50px auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 9999;
      display: none;
    }
    
    /* カルテ一覧 */
    #karte-list {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    #karte-list th,
    #karte-list td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #karte-list th { background-color: #f2f2f2; }
    #karte-list tr:nth-child(even) { background-color: #f9f9f9; }
    #karte-list tr:hover { background-color: #f1f1f1; }
    .search-container { margin-bottom: 10px; }
    #search {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .edit-btn, .delete-btn {
      padding: 5px 10px;
      margin-right: 5px;
      font-size: 12px;
    }
    .delete-btn { background-color: #f44336; }
    .delete-btn:hover { background-color: #d32f2f; }
    
    footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }

    /* スマホ向けレスポンシブ調整 */
    @media (max-width: 768px) {
      body { padding: 10px; }
      .app-container {
        max-width: 100%;
        padding: 10px;
      }
      header, .action-buttons, footer {
        flex-direction: column;
        text-align: center;
      }
      .action-buttons button {
        margin-bottom: 10px;
      }
      .form-label {
        width: 100%;
        margin-bottom: 5px;
      }
      .form-field {
        width: 100%;
      }
      #karte-list th, #karte-list td {
        font-size: 14px;
      }
    }
    @media (max-width: 480px) {
      .app-title h1 { font-size: 20px; }
      .app-info { font-size: 12px; }
      button { font-size: 14px; padding: 6px 12px; }
      .info-card-body {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="app-title"><h1>団体ナビ成約カルテ</h1></div>
      <div class="app-info">
        <div>カルテNo: <span id="current-karte-id">新規カルテ</span></div>
        <div>最終更新: <span id="last-saved">-</span></div>
      </div>
    </header>
    <div class="action-buttons">
      <button id="save-btn">保存</button>
      <button id="new-btn">新規</button>
      <button id="open-btn">開く</button>
      <button id="export-btn">エクスポート</button>
    </div>
    <main>
      <!-- 基本情報セクション -->
      <div class="section-container basic-section">
        <div class="section-header">◆ 基本情報</div>
        <div class="form-section">
          <div class="form-row">
            <div class="form-label">国内/海外</div>
            <div class="form-field">
              <select id="travel-type">
                <option value="domestic">国内</option>
                <option value="international">海外</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">カルテ番号</div>
            <div class="form-field">
              <input type="text" id="karte-no" placeholder="カルテ番号（国内はD、海外はIから始まる）">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">自社担当者</div>
            <div class="form-field">
              <input type="text" id="company-person" placeholder="自社担当者名">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">クライアント会社名</div>
            <div class="form-field">
              <input type="text" id="client-company" placeholder="クライアント会社名">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">クライアント担当者</div>
            <div class="form-field">
              <input type="text" id="client-person" placeholder="担当者名">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">電話番号</div>
            <div class="form-field">
              <input type="tel" id="client-phone" placeholder="電話番号">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">メールアドレス</div>
            <div class="form-field">
              <input type="email" id="client-email" placeholder="メールアドレス">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">出発日</div>
            <div class="form-field">
              <input type="date" id="departure-date">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">帰着日</div>
            <div class="form-field">
              <input type="date" id="return-date">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">泊数</div>
            <div class="form-field">
              <input type="number" id="nights" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">出発地</div>
            <div class="form-field">
              <input type="text" id="departure-place" placeholder="出発地">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">行き先</div>
            <div class="form-field">
              <select id="destination">
                <option value="">選択してください</option>
                <option value="北海道">北海道</option>
                <option value="青森県">青森県</option>
                <option value="岩手県">岩手県</option>
                <option value="宮城県">宮城県</option>
                <option value="秋田県">秋田県</option>
                <option value="山形県">山形県</option>
                <option value="福島県">福島県</option>
                <option value="茨城県">茨城県</option>
                <option value="栃木県">栃木県</option>
                <option value="群馬県">群馬県</option>
                <option value="埼玉県">埼玉県</option>
                <option value="千葉県">千葉県</option>
                <option value="東京都">東京都</option>
                <option value="神奈川県">神奈川県</option>
                <option value="新潟県">新潟県</option>
                <option value="富山県">富山県</option>
                <option value="石川県">石川県</option>
                <option value="福井県">福井県</option>
                <option value="山梨県">山梨県</option>
                <option value="長野県">長野県</option>
                <option value="岐阜県">岐阜県</option>
                <option value="静岡県">静岡県</option>
                <option value="愛知県">愛知県</option>
                <option value="三重県">三重県</option>
                <option value="滋賀県">滋賀県</option>
                <option value="京都府">京都府</option>
                <option value="大阪府">大阪府</option>
                <option value="兵庫県">兵庫県</option>
                <option value="奈良県">奈良県</option>
                <option value="和歌山県">和歌山県</option>
                <option value="鳥取県">鳥取県</option>
                <option value="島根県">島根県</option>
                <option value="岡山県">岡山県</option>
                <option value="広島県">広島県</option>
                <option value="山口県">山口県</option>
                <option value="徳島県">徳島県</option>
                <option value="香川県">香川県</option>
                <option value="愛媛県">愛媛県</option>
                <option value="高知県">高知県</option>
                <option value="福岡県">福岡県</option>
                <option value="佐賀県">佐賀県</option>
                <option value="長崎県">長崎県</option>
                <option value="熊本県">熊本県</option>
                <option value="大分県">大分県</option>
                <option value="宮崎県">宮崎県</option>
                <option value="鹿児島県">鹿児島県</option>
                <option value="沖縄県">沖縄県</option>
                <option value="other">その他（海外など）</option>
              </select>
              <input type="text" id="destination-other" placeholder="その他の行き先" style="display: none; margin-top: 5px;">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">旅行内容</div>
            <div class="form-field">
              <textarea id="travel-content" placeholder="旅行内容の詳細"></textarea>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">合計人数</div>
            <div class="form-field">
              <input type="number" id="total-persons" placeholder="合計人数">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">金額</div>
            <div class="form-field">
              <input type="number" id="total-amount" placeholder="旅行総額">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">単価</div>
            <div class="form-field">
              <input type="number" id="unit-price" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">支払い先</div>
            <div class="form-field">
              <input type="text" id="payment-to" placeholder="支払い先">
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">手配状況</div>
            <div class="form-field">
              <select id="arrangement-status">
                <option value="not-started">未着手</option>
                <option value="in-progress">手配中</option>
                <option value="completed">手配完了</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <!-- 入金情報セクション -->
      <div class="section-container payment-section">
        <div class="section-header">◆ 入金情報</div>
        <div class="form-section">
          <div id="payment-list">
            <!-- 入金情報カードがここに動的に追加されます -->
          </div>
          <button id="add-payment" class="add-item-btn">入金情報を追加</button>
        </div>
      </div>

      <!-- 支払情報セクション -->
      <div class="section-container expense-section">
        <div class="section-header">◆ 支払情報</div>
        <div class="form-section">
          <div id="expense-list">
            <!-- 支払情報カードがここに動的に追加されます -->
          </div>
          <button id="add-expense" class="add-item-btn">支払情報を追加</button>
        </div>
      </div>

      <!-- 収支情報セクション -->
      <div class="section-container summary-section">
        <div class="section-header">◆ 収支情報</div>
        <div class="form-section">
          <div class="form-row">
            <div class="form-label">総入金額</div>
            <div class="form-field">
              <input type="text" id="total-payment" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">総支払額</div>
            <div class="form-field">
              <input type="text" id="total-expense" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">利益額</div>
            <div class="form-field">
              <input type="text" id="profit-amount" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">利益率</div>
            <div class="form-field">
              <input type="text" id="profit-rate" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">一人あたり利益</div>
            <div class="form-field">
              <input type="text" id="profit-per-person" readonly>
            </div>
          </div>
        </div>
      </div>

      <!-- メモ欄セクション -->
      <div class="section-container memo-section">
        <div class="section-header">◆ メモ欄</div>
        <div class="form-section">
          <textarea id="memo" placeholder="自由にメモを記入してください" rows="5" style="width: 100%;"></textarea>
        </div>
      </div>

      <!-- コメントセクション -->
      <div class="section-container comments-section">
        <div class="section-header">◆ コメント欄</div>
        <div class="form-section">
          <div class="comment-input">
            <textarea id="comment-text" placeholder="コメントを入力してください"></textarea>
            <button id="post-comment">投稿</button>
          </div>
          <div id="comment-thread" class="comment-thread">
            <!-- コメントがここに動的に追加されます -->
          </div>
        </div>
      </div>
    </main>
    <footer>
      <div>カルテシステム v2.0</div>
      <div>接続状態: <span id="connection-status">オンライン</span></div>
    </footer>
  </div>

  <!-- カルテ一覧モーダル -->
  <div id="list-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>カルテ一覧</h2>
      <!-- 検索バー -->
      <div class="search-container">
        <input type="text" id="search" placeholder="検索..." />
      </div>
      <table id="karte-list">
        <thead>
          <tr>
            <th>カルテNo</th>
            <th>担当者</th>
            <th>会社名</th>
            <th>出発日</th>
            <th>行先</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody><!-- JSで行を追加 --></tbody>
      </table>
    </div>
  </div>

  <!-- 入金情報追加モーダル -->
  <div id="payment-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>入金情報の追加</h2>
      <div class="form-section">
        <div class="form-row">
          <div class="form-label">入金予定日</div>
          <div class="form-field">
            <input type="date" id="payment-due-date">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">入金日</div>
          <div class="form-field">
            <input type="date" id="payment-date">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">入金額</div>
          <div class="form-field">
            <input type="number" id="payment-amount" placeholder="入金額">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">入金場所</div>
          <div class="form-field">
            <input type="text" id="payment-place" placeholder="入金場所">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">備考</div>
          <div class="form-field">
            <textarea id="payment-notes" placeholder="備考"></textarea>
          </div>
        </div>
        <div class="form-row">
          <button id="save-payment" style="margin-left: auto;">保存</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 支払情報追加モーダル -->
  <div id="expense-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>支払情報の追加</h2>
      <div class="form-section">
        <div class="form-row">
          <div class="form-label">利用日</div>
          <div class="form-field">
            <input type="date" id="expense-date">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">手配先名</div>
          <div class="form-field">
            <input type="text" id="expense-vendor" placeholder="手配先名">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">電話/FAX</div>
          <div class="form-field">
            <input type="text" id="expense-phone" placeholder="電話/FAX番号">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">担当者</div>
          <div class="form-field">
            <input type="text" id="expense-person" placeholder="担当者名">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">支払予定日</div>
          <div class="form-field">
            <input type="date" id="expense-due-date">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">支払金額</div>
          <div class="form-field">
            <input type="number" id="expense-amount" placeholder="支払金額">
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">手配状況</div>
          <div class="form-field">
            <select id="expense-status">
              <option value="未手配">未手配</option>
              <option value="手配中">手配中</option>
              <option value="手配完了">手配完了</option>
              <option value="支払済み">支払済み</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">備考</div>
          <div class="form-field">
            <textarea id="expense-notes" placeholder="備考"></textarea>
          </div>
        </div>
        <div class="form-row">
          <button id="save-expense" style="margin-left: auto;">保存</button>
        </div>
      </div>
    </div>
  </div>

  <div id="notification" class="notification"></div>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script>
    // ========= Firebase設定 =========
    const firebaseConfig = {
      apiKey: "AIzaSyExample",
      authDomain: "travelkarute.firebaseapp.com",
      projectId: "travelkarute",
      storageBucket: "travelkarute.appspot.com",
      messagingSenderId: "635350270309",
      appId: "1:635350270309:web:2498d21f9f134defeda18c"
    };
    try {
      firebase.initializeApp(firebaseConfig);
      window.db = firebase.firestore();
      db.enablePersistence({ synchronizeTabs: true })
        .catch(err => { console.warn("Persistence error:", err); });
    } catch (error) {
      console.error("Firebase初期化エラー:", error);
      setTimeout(() => { alert("サーバー接続に問題が発生しました。ページをリロードしてください。"); }, 1000);
    }
    
    // ========= カルテアプリケーション =========
    const KarteApp = {
      currentId: null,
      hasChanges: false,
      payments: [], // 入金情報の配列
      expenses: [], // 支払情報の配列
      comments: [], // コメントの配列
      debounceTimer: null, // debounce 用タイマー
      
      init: function() {
        console.log("KarteApp.init() start");
        this.setupEventListeners();
        this.createNew();
        // スマホの場合のみモーダルを自動表示、PCの場合は非表示
        if (/Mobi|Android|iPhone|iPad|iPod/.test(navigator.userAgent)) {
          document.getElementById('list-modal').style.display = 'block';
        } else {
          document.getElementById('list-modal').style.display = 'none';
        }
        console.log("KarteApp.init() end");
      },
      
      setupEventListeners: function() {
        console.log("setupEventListeners() start");
        // メインボタン
        document.getElementById('save-btn').addEventListener('click', () => { this.saveKarte(); });
        document.getElementById('new-btn').addEventListener('click', () => {
          if (this.hasChanges && !confirm('保存されていない変更があります。新規カルテを作成しますか？')) { return; }
          this.createNew();
        });
        document.getElementById('open-btn').addEventListener('click', () => { this.loadKarteList(); });
        document.getElementById('export-btn').addEventListener('click', () => { this.exportToExcel(); });
        
        // 自動計算フィールド
        document.getElementById('departure-date').addEventListener('change', () => this.calculateNights());
        document.getElementById('return-date').addEventListener('change', () => this.calculateNights());
        document.getElementById('total-amount').addEventListener('input', () => this.calculateUnitPrice());
        document.getElementById('total-persons').addEventListener('input', () => this.calculateUnitPrice());
        
        // 国内/海外選択時のカルテ番号プレフィックス設定
        document.getElementById('travel-type').addEventListener('change', (e) => {
          const prefix = e.target.value === 'domestic' ? 'D' : 'I';
          const karteNoInput = document.getElementById('karte-no');
          const currentValue = karteNoInput.value;
          // 既存のD/Iプレフィックスを取り除く
          let numericPart = currentValue.replace(/^[DI]-/, '');
          karteNoInput.value = `${prefix}-${numericPart}`;
        });
        
        // 行き先が「その他」の場合にテキスト入力を表示
        document.getElementById('destination').addEventListener('change', (e) => {
          const otherInput = document.getElementById('destination-other');
          if (e.target.value === 'other') {
            otherInput.style.display = 'block';
          } else {
            otherInput.style.display = 'none';
          }
        });
        
        // 入金情報の追加ボタン
        document.getElementById('add-payment').addEventListener('click', () => {
          // モーダルを初期化して表示
          document.getElementById('payment-due-date').value = '';
          document.getElementById('payment-date').value = '';
          document.getElementById('payment-amount').value = '';
          document.getElementById('payment-place').value = '';
          document.getElementById('payment-notes').value = '';
          document.getElementById('payment-modal').style.display = 'block';
        });
        
        // 入金情報の保存ボタン
        document.getElementById('save-payment').addEventListener('click', () => {
          const payment = {
            id: Date.now().toString(), // ユニークID
            dueDate: document.getElementById('payment-due-date').value,
            date: document.getElementById('payment-date').value,
            amount: parseFloat(document.getElementById('payment-amount').value) || 0,
            place: document.getElementById('payment-place').value,
            notes: document.getElementById('payment-notes').value
          };
          this.payments.push(payment);
          this.renderPayments();
          this.updateSummary();
          document.getElementById('payment-modal').style.display = 'none';
          this.markHasChanges();
        });
        
        // 支払情報の追加ボタン
        document.getElementById('add-expense').addEventListener('click', () => {
          // モーダルを初期化して表示
          document.getElementById('expense-date').value = '';
          document.getElementById('expense-vendor').value = '';
          document.getElementById('expense-phone').value = '';
          document.getElementById('expense-person').value = '';
          document.getElementById('expense-due-date').value = '';
          document.getElementById('expense-amount').value = '';
          document.getElementById('expense-status').value = '未手配';
          document.getElementById('expense-notes').value = '';
          document.getElementById('expense-modal').style.display = 'block';
        });
        
        // 支払情報の保存ボタン
        document.getElementById('save-expense').addEventListener('click', () => {
          const expense = {
            id: Date.now().toString(), // ユニークID
            date: document.getElementById('expense-date').value,
            vendor: document.getElementById('expense-vendor').value,
            phone: document.getElementById('expense-phone').value,
            person: document.getElementById('expense-person').value,
            dueDate: document.getElementById('expense-due-date').value,
            amount: parseFloat(document.getElementById('expense-amount').value) || 0,
            status: document.getElementById('expense-status').value,
            notes: document.getElementById('expense-notes').value
          };
          this.expenses.push(expense);
          this.renderExpenses();
          this.updateSummary();
          document.getElementById('expense-modal').style.display = 'none';
          this.markHasChanges();
        });
        
        // コメント投稿ボタン
        document.getElementById('post-comment').addEventListener('click', () => {
          const commentText = document.getElementById('comment-text').value.trim();
          if (commentText) {
            const comment = {
              id: Date.now().toString(),
              text: commentText,
              date: new Date().toISOString(),
              author: document.getElementById('company-person').value || '担当者'
            };
            this.comments.unshift(comment); // 新しいコメントを先頭に追加
            this.renderComments();
            document.getElementById('comment-text').value = '';
            this.markHasChanges();
          }
        });
        
        // モーダル関連
        document.querySelectorAll('.close').forEach(closeBtn => {
          closeBtn.addEventListener('click', () => {
            document.querySelectorAll('.modal').forEach(modal => {
              modal.style.display = 'none';
            });
          });
        });
        
        document.getElementById('search').addEventListener('input', (e) => { 
          this.filterKarteList(e.target.value); 
        });
        
        window.addEventListener('click', (event) => { 
          document.querySelectorAll('.modal').forEach(modal => {
            if (event.target === modal) { 
              modal.style.display = 'none'; 
            }
          });
        });
        
        // オンライン・オフライン
        window.addEventListener('online', () => {
          document.getElementById('connection-status').textContent = 'オンライン';
          document.getElementById('connection-status').style.color = '';
          this.showNotification('ネットワーク接続が復旧しました', 'success');
        });
        window.addEventListener('offline', () => {
          document.getElementById('connection-status').textContent = 'オフライン';
          document.getElementById('connection-status').style.color = 'red';
          this.showNotification('オフライン状態になりました', 'warning');
        });
        
        // ページ離脱前
        window.addEventListener('beforeunload', (e) => {
          if (this.hasChanges) {
            e.preventDefault();
            e.returnValue = '保存されていない変更があります。ページを離れますか？';
            return e.returnValue;
          }
        });
        console.log("setupEventListeners() end");
      },
      showNotification: function(message, type = 'info') {
        console.log("showNotification:", message, type);
        const notification = document.getElementById('notification');
        if (!notification) { 
          console.error("通知エレメントが見つかりません"); 
          return; 
        }
        notification.textContent = message;
        switch (type) {
          case 'success': notification.style.backgroundColor = '#4caf50'; break;
          case 'error': notification.style.backgroundColor = '#f44336'; break;
          case 'warning': notification.style.backgroundColor = '#ff9800'; break;
          default: notification.style.backgroundColor = '#2196F3';
        }
        notification.style.display = 'block';
        setTimeout(() => { notification.style.display = 'none'; }, 3000);
      },
      
      createNew: function() {
        console.log("createNew() called");
        this.currentId = null;
        document.getElementById('current-karte-id').textContent = '新規カルテ';
        document.getElementById('last-saved').textContent = '-';
        
        // 全フィールドをクリア
        const inputs = document.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
          if (input.type === 'checkbox' || input.type === 'radio') {
            input.checked = false;
          } else {
            input.value = '';
          }
        });
        
        // 国内/海外の初期値を設定
        document.getElementById('travel-type').value = 'domestic';
        document.getElementById('destination-other').style.display = 'none';
        
        // カルテ番号の初期値設定
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        document.getElementById('karte-no').value = `D-${yyyy}${mm}${dd}-`;
        
        // 配列をクリア
        this.payments = [];
        this.expenses = [];
        this.comments = [];
        
        // 各セクションを再描画
        this.renderPayments();
        this.renderExpenses();
        this.renderComments();
        this.updateSummary();
        
        this.hasChanges = false;
      },
      
      calculateNights: function() {
        const departureDate = document.getElementById('departure-date').value;
        const returnDate = document.getElementById('return-date').value;
        
        if (departureDate && returnDate) {
          const start = new Date(departureDate);
          const end = new Date(returnDate);
          const diffTime = Math.abs(end - start);
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          document.getElementById('nights').value = diffDays;
          this.markHasChanges();
        }
      },
      
      calculateUnitPrice: function() {
        const amount = parseFloat(document.getElementById('total-amount').value) || 0;
        const persons = parseInt(document.getElementById('total-persons').value) || 0;
        
        if (amount > 0 && persons > 0) {
          const unitPrice = Math.round(amount / persons);
          document.getElementById('unit-price').value = unitPrice;
          this.markHasChanges();
        } else {
          document.getElementById('unit-price').value = '';
        }
      },
      
      renderPayments: function() {
        const container = document.getElementById('payment-list');
        container.innerHTML = '';
        
        if (this.payments.length === 0) {
          container.innerHTML = '<p>入金情報がありません</p>';
          return;
        }
        
        this.payments.forEach(payment => {
          const card = document.createElement('div');
          card.className = 'info-card';
          card.innerHTML = `
            <div class="info-card-header">
              <span>${payment.date ? '入金済み' : '入金予定'}</span>
              <button class="remove-card-btn" data-id="${payment.id}">削除</button>
            </div>
            <div class="info-card-body">
              <div class="info-card-item">
                <div class="info-card-label">入金予定日</div>
                <div class="info-card-value">${payment.dueDate || '未設定'}</div>
              </div>
              <div class="info-card-item">
                <div class="info-card-label">入金日</div>
                <div class="info-card-value">${payment.date || '未入金'}</div>
              </div>
              <div class="info-card-item">
                <div class="info-card-label">入金額</div>
                <div class="info-card-value">${payment.amount.toLocaleString()}円</div>
              </div>
              <div class="info-card-item">
                <div class="info-card-label">入金場所</div>
                <div class="info-card-value">${payment.place || '-'}</div>
              </div>
            </div>
            ${payment.notes ? `<div class="info-card-notes">${payment.notes}</div>` : ''}
          `;
          container.appendChild(card);
        });
        
        // 削除ボタンにイベントリスナーを追加
        document.querySelectorAll('#payment-list .remove-card-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.getAttribute('data-id');
            this.payments = this.payments.filter(item => item.id !== id);
            this.renderPayments();
            this.updateSummary();
            this.markHasChanges();
          });
        });
      },
      
      renderExpenses: function() {
        const container = document.getElementById('expense-list');
        container.innerHTML = '';
        
        if (this.expenses.length === 0) {
          container.innerHTML = '<p>支払情報がありません</p>';
          return;
        }
        
        this.expenses.forEach(expense => {
          const card = document.createElement('div');
          card.className = 'info-card';
          card.innerHTML = `
            <div class="info-card-header">
              <span>${expense.vendor} (${expense.status})</span>
              <button class="remove-card-btn" data-id="${expense.id}">削除</button>
            </div>
            <div class="info-card-body">
              <div class="info-card-item">
                <div class="info-card-label">利用日</div>
                <div class="info-card-value">${expense.date || '-'}</div>
              </div>
              <div class="info-card-item">
                <div class="info-card-label">担当者</div>
                <div class="info-card-value">${expense.person || '-'}</div>
              </div>
              <div class="info-card-item">
                <div class="info-card-label">支払予定日</div>
                <div class="info-card-value">${expense.dueDate || '-'}</div>
              </div>
              <div class="info-card-item">
                <div class="info-card-label">支払金額</div>
                <div class="info-card-value">${expense.amount.toLocaleString()}円</div>
              </div>
            </div>
            ${expense.notes ? `<div class="info-card-notes">${expense.notes}</div>` : ''}
          `;
          container.appendChild(card);
        });
        
        // 削除ボタンにイベントリスナーを追加
        document.querySelectorAll('#expense-list .remove-card-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const id = e.target.getAttribute('data-id');
            this.expenses = this.expenses.filter(item => item.id !== id);
            this.renderExpenses();
            this.updateSummary();
            this.markHasChanges();
          });
        });
      },
      
      renderComments: function() {
        const container = document.getElementById('comment-thread');
        container.innerHTML = '';
        
        if (this.comments.length === 0) {
          container.innerHTML = '<p>コメントはありません</p>';
          return;
        }
        
        this.comments.forEach(comment => {
          const date = new Date(comment.date);
          const formattedDate = `${date.getFullYear()}/${(date.getMonth()+1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
          
          const commentDiv = document.createElement('div');
          commentDiv.className = 'comment-item';
          commentDiv.innerHTML = `
            <div class="comment-meta">
              <strong>${comment.author}</strong> - ${formattedDate}
            </div>
            <div class="comment-text">${comment.text}</div>
          `;
          container.appendChild(commentDiv);
        });
      },
      
      updateSummary: function() {
        // 入金の合計を計算
        const totalPayment = this.payments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
        document.getElementById('total-payment').value = totalPayment.toLocaleString() + '円';
        
        // 支払の合計を計算
        const totalExpense = this.expenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);
        document.getElementById('total-expense').value = totalExpense.toLocaleString() + '円';
        
        // 利益額を計算
        const profit = totalPayment - totalExpense;
        document.getElementById('profit-amount').value = profit.toLocaleString() + '円';
        
        // 利益率を計算
        const profitRate = totalPayment > 0 ? (profit / totalPayment * 100).toFixed(1) : 0;
        document.getElementById('profit-rate').value = profitRate + '%';
        
        // 一人あたり利益を計算
        const persons = parseInt(document.getElementById('total-persons').value) || 0;
        const profitPerPerson = persons > 0 ? Math.round(profit / persons) : 0;
        document.getElementById('profit-per-person').value = profitPerPerson.toLocaleString() + '円';
      },
      
      saveKarte: function() {
        console.log("saveKarte() called");
        if (!navigator.onLine) {
          this.showNotification('オフライン状態では保存できません', 'error');
          return;
        }
        
        document.getElementById('last-saved').textContent = '保存中...';
        
        try {
          // フォームから基本情報を取得
          const karteData = this.getFormData();
          
          // 配列データを追加
          karteData.payments = this.payments;
          karteData.expenses = this.expenses;
          karteData.comments = this.comments;
          
          // タイムスタンプを追加
          karteData.lastUpdated = firebase.firestore.FieldValue.serverTimestamp();
          
          // カルテ情報を抽出（一覧表示用）
          const karteInfo = {
            karteNo: document.getElementById('karte-no').value || '',
            tantosha: document.getElementById('company-person').value || '',
            dantaiName: document.getElementById('client-company').value || '',
            departureDate: document.getElementById('departure-date').value || '',
            personCount: document.getElementById('total-persons').value || '',
            destination: this.getDestinationValue()
          };
          karteData.karteInfo = karteInfo;
          
          let savePromise;
          if (this.currentId) {
            console.log("Updating existing document, id =", this.currentId);
            savePromise = db.collection('karte').doc(this.currentId).update(karteData);
          } else {
            console.log("Creating new document");
            savePromise = db.collection('karte').add(karteData)
              .then(docRef => { this.currentId = docRef.id; return docRef; });
          }
          
          savePromise.then(() => {
            const now = new Date();
            document.getElementById('last-saved').textContent = now.toLocaleString();
            document.getElementById('current-karte-id').textContent = karteInfo.karteNo || '新規カルテ';
            this.hasChanges = false;
            this.showNotification('カルテを保存しました', 'success');
            console.log("saveKarte: save succeeded");
          }).catch(error => {
            console.error('保存エラー:', error);
            document.getElementById('last-saved').textContent = '保存失敗';
            this.showNotification('保存に失敗しました: ' + error.message, 'error');
          });
        } catch (error) {
          console.error('データ準備エラー:', error);
          document.getElementById('last-saved').textContent = '保存失敗';
          this.showNotification('データの準備中にエラーが発生しました', 'error');
        }
      },
      
      getFormData: function() {
        return {
          travelType: document.getElementById('travel-type').value,
          karteNo: document.getElementById('karte-no').value,
          companyPerson: document.getElementById('company-person').value,
          clientCompany: document.getElementById('client-company').value,
          clientPerson: document.getElementById('client-person').value,
          clientPhone: document.getElementById('client-phone').value,
          clientEmail: document.getElementById('client-email').value,
          departureDate: document.getElementById('departure-date').value,
          returnDate: document.getElementById('return-date').value,
          nights: document.getElementById('nights').value,
          departurePlace: document.getElementById('departure-place').value,
          destination: this.getDestinationValue(),
          travelContent: document.getElementById('travel-content').value,
          totalPersons: document.getElementById('total-persons').value,
          totalAmount: document.getElementById('total-amount').value,
          unitPrice: document.getElementById('unit-price').value,
          paymentTo: document.getElementById('payment-to').value,
          arrangementStatus: document.getElementById('arrangement-status').value,
          memo: document.getElementById('memo').value
        };
      },
      
      getDestinationValue: function() {
        const select = document.getElementById('destination');
        if (select.value === 'other') {
          return document.getElementById('destination-other').value;
        }
        return select.value;
      },
      
      loadKarteList: function() {
        console.log("loadKarteList() called");
        if (this.hasChanges && !confirm('保存されていない変更があります。カルテ一覧を開きますか？')) { return; }
        
        const listBody = document.querySelector('#karte-list tbody');
        listBody.innerHTML = '<tr><td colspan="6">読み込み中...</td></tr>';
        document.getElementById('list-modal').style.display = 'block';
        document.getElementById('search').value = '';
        
        db.collection('karte').orderBy('lastUpdated', 'desc').limit(50).get()
          .then(querySnapshot => {
            if (querySnapshot.empty) {
              listBody.innerHTML = '<tr><td colspan="6">カルテがありません</td></tr>';
              return;
            }
            
            let html = '';
            querySnapshot.forEach(doc => {
              const data = doc.data();
              const info = data.karteInfo || {};
              html += `
                <tr data-id="${doc.id}">
                  <td>${info.karteNo || '-'}</td>
                  <td>${info.tantosha || '-'}</td>
                  <td>${info.dantaiName || '-'}</td>
                  <td>${info.departureDate || '-'}</td>
                  <td>${info.destination || '-'}</td>
                  <td>
                    <button class="edit-btn" data-id="${doc.id}">編集</button>
                    <button class="delete-btn" data-id="${doc.id}">削除</button>
                  </td>
                </tr>
              `;
            });
            
            listBody.innerHTML = html;
            
            document.querySelectorAll('.edit-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                this.loadKarte(id);
                document.getElementById('list-modal').style.display = 'none';
              });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                if (confirm('本当に削除しますか？')) { this.deleteKarte(id); }
              });
            });
          })
          .catch(error => {
            console.error('カルテリスト取得エラー:', error);
            listBody.innerHTML = `<tr><td colspan="6">エラー: ${error.message}</td></tr>`;
            this.showNotification('カルテ一覧の取得に失敗しました', 'error');
          });
      },
      loadKarte: function(id) {
        console.log("loadKarte() called, id=", id);
        if (this.hasChanges && !confirm('保存されていない変更があります。別のカルテを開きますか？')) { return; }
        
        document.getElementById('last-saved').textContent = '読み込み中...';
        
        db.collection('karte').doc(id).get()
          .then(doc => {
            if (!doc.exists) {
              this.showNotification('カルテが見つかりません', 'error');
              document.getElementById('last-saved').textContent = '-';
              return;
            }
            
            const data = doc.data();
            this.currentId = id;
            
            // 基本フォームデータをセット
            this.setFormData(data);
            
            // 配列データをセット
            this.payments = Array.isArray(data.payments) ? data.payments : [];
            this.expenses = Array.isArray(data.expenses) ? data.expenses : [];
            this.comments = Array.isArray(data.comments) ? data.comments : [];
            
            // 各セクションを再描画
            this.renderPayments();
            this.renderExpenses();
            this.renderComments();
            this.updateSummary();
            
            // カルテ番号と最終更新日を表示
            const karteInfo = data.karteInfo || {};
            document.getElementById('current-karte-id').textContent = karteInfo.karteNo || '新規カルテ';
            document.getElementById('last-saved').textContent = data.lastUpdated ? data.lastUpdated.toDate().toLocaleString() : '-';
            
            this.hasChanges = false;
            this.showNotification('カルテを読み込みました', 'success');
            console.log("loadKarte() succeeded");
          })
          .catch(error => {
            console.error('カルテ読み込みエラー:', error);
            document.getElementById('last-saved').textContent = '読み込み失敗';
            this.showNotification('カルテの読み込みに失敗しました', 'error');
          });
      },
      
      setFormData: function(data) {
        // 基本フォームデータを設定
        if (data.travelType) document.getElementById('travel-type').value = data.travelType;
        if (data.karteNo) document.getElementById('karte-no').value = data.karteNo;
        if (data.companyPerson) document.getElementById('company-person').value = data.companyPerson;
        if (data.clientCompany) document.getElementById('client-company').value = data.clientCompany;
        if (data.clientPerson) document.getElementById('client-person').value = data.clientPerson;
        if (data.clientPhone) document.getElementById('client-phone').value = data.clientPhone;
        if (data.clientEmail) document.getElementById('client-email').value = data.clientEmail;
        if (data.departureDate) document.getElementById('departure-date').value = data.departureDate;
        if (data.returnDate) document.getElementById('return-date').value = data.returnDate;
        if (data.nights) document.getElementById('nights').value = data.nights;
        if (data.departurePlace) document.getElementById('departure-place').value = data.departurePlace;
        
        // 行き先の設定
        if (data.destination) {
          const destinationSelect = document.getElementById('destination');
          const destinationOther = document.getElementById('destination-other');
          
          // 都道府県リストにあるか確認
          const options = Array.from(destinationSelect.options).map(opt => opt.value);
          if (options.includes(data.destination)) {
            destinationSelect.value = data.destination;
            destinationOther.style.display = 'none';
          } else {
            destinationSelect.value = 'other';
            destinationOther.style.display = 'block';
            destinationOther.value = data.destination;
          }
        }
        
        if (data.travelContent) document.getElementById('travel-content').value = data.travelContent;
        if (data.totalPersons) document.getElementById('total-persons').value = data.totalPersons;
        if (data.totalAmount) document.getElementById('total-amount').value = data.totalAmount;
        if (data.unitPrice) document.getElementById('unit-price').value = data.unitPrice;
        if (data.paymentTo) document.getElementById('payment-to').value = data.paymentTo;
        if (data.arrangementStatus) document.getElementById('arrangement-status').value = data.arrangementStatus;
        if (data.memo) document.getElementById('memo').value = data.memo;
      },
      
      deleteKarte: function(id) {
        console.log("deleteKarte() called, id=", id);
        
        db.collection('karte').doc(id).delete()
          .then(() => {
            this.showNotification('カルテを削除しました', 'success');
            this.loadKarteList();
            if (this.currentId === id) { this.createNew(); }
          })
          .catch(error => {
            console.error('削除エラー:', error);
            this.showNotification('削除に失敗しました: ' + error.message, 'error');
          });
      },
      
      exportToExcel: function() {
        console.log("exportToExcel() called");
        
        try {
          const wb = XLSX.utils.book_new();
          
          // 基本情報シート
          const basicData = [
            ['◆ 基本情報', ''],
            ['国内/海外', document.getElementById('travel-type').value === 'domestic' ? '国内' : '海外'],
            ['カルテ番号', document.getElementById('karte-no').value],
            ['自社担当者', document.getElementById('company-person').value],
            ['クライアント会社名', document.getElementById('client-company').value],
            ['クライアント担当者', document.getElementById('client-person').value],
            ['電話番号', document.getElementById('client-phone').value],
            ['メールアドレス', document.getElementById('client-email').value],
            ['出発日', document.getElementById('departure-date').value],
            ['帰着日', document.getElementById('return-date').value],
            ['泊数', document.getElementById('nights').value],
            ['出発地', document.getElementById('departure-place').value],
            ['行き先', this.getDestinationValue()],
            ['旅行内容', document.getElementById('travel-content').value],
            ['合計人数', document.getElementById('total-persons').value],
            ['金額', document.getElementById('total-amount').value],
            ['単価', document.getElementById('unit-price').value],
            ['支払い先', document.getElementById('payment-to').value],
            ['手配状況', document.getElementById('arrangement-status').value]
          ];
          
          // 入金情報シート
          const paymentData = [['◆ 入金情報', '', '', '', '']];
          paymentData.push(['入金予定日', '入金日', '入金額', '入金場所', '備考']);
          this.payments.forEach(payment => {
            paymentData.push([
              payment.dueDate || '',
              payment.date || '',
              payment.amount,
              payment.place || '',
              payment.notes || ''
            ]);
          });
          
          // 支払情報シート
          const expenseData = [['◆ 支払情報', '', '', '', '', '', '']];
          expenseData.push(['利用日', '手配先名', '電話/FAX', '担当者', '支払予定日', '支払金額', '手配状況']);
          this.expenses.forEach(expense => {
            expenseData.push([
              expense.date || '',
              expense.vendor || '',
              expense.phone || '',
              expense.person || '',
              expense.dueDate || '',
              expense.amount,
              expense.status || ''
            ]);
          });
          
          // 収支情報シート
          const summaryData = [
            ['◆ 収支情報', ''],
            ['総入金額', document.getElementById('total-payment').value],
            ['総支払額', document.getElementById('total-expense').value],
            ['利益額', document.getElementById('profit-amount').value],
            ['利益率', document.getElementById('profit-rate').value],
            ['一人あたり利益', document.getElementById('profit-per-person').value]
          ];
          
          // メモ欄シート
          const memoData = [
            ['◆ メモ欄', ''],
            [document.getElementById('memo').value, '']
          ];
          
          // コメントシート
          const commentData = [['◆ コメント欄', '', '']];
          commentData.push(['投稿者', '日時', 'コメント']);
          this.comments.forEach(comment => {
            const date = new Date(comment.date);
            const formattedDate = date.toLocaleString();
            commentData.push([comment.author, formattedDate, comment.text]);
          });
          
          // シートを追加
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(basicData), '基本情報');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(paymentData), '入金情報');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(expenseData), '支払情報');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryData), '収支情報');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(memoData), 'メモ');
          XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(commentData), 'コメント');
          
          // ファイル名を設定して出力
          const karteNo = document.getElementById('karte-no').value || '';
          const now = new Date();
          const y = now.getFullYear();
          const m = ('0' + (now.getMonth() + 1)).slice(-2);
          const d = ('0' + now.getDate()).slice(-2);
          const filename = `${karteNo || 'カルテ'}_${y}${m}${d}.xlsx`;
          
          XLSX.writeFile(wb, filename);
          this.showNotification('Excelファイルを出力しました', 'success');
          console.log("exportToExcel() succeeded");
        } catch (error) {
          console.error('エクスポートエラー:', error);
          this.showNotification('エクスポートに失敗しました: ' + error.message, 'error');
        }
      },
      
      filterKarteList: function(searchText) {
        console.log("filterKarteList() called, searchText=", searchText);
        
        const rows = document.querySelectorAll('#karte-list tbody tr');
        searchText = searchText.toLowerCase();
        let foundCount = 0;
        
        rows.forEach(row => {
          if (row.querySelector('td[colspan]')) { return; }
          
          let found = false;
          const cells = row.querySelectorAll('td:not(:last-child)');
          cells.forEach(cell => { 
            if (cell.textContent.toLowerCase().includes(searchText)) { found = true; } 
          });
          
          row.style.display = found ? '' : 'none';
          if (found) { foundCount++; }
        });
        
        if (foundCount === 0 && searchText) {
          const listBody = document.querySelector('#karte-list tbody');
          const noResultRow = document.getElementById('no-results-row');
          
          if (noResultRow) { noResultRow.remove(); }
          
          if (rows.length > 0) {
            const message = document.createElement('tr');
            message.id = 'no-results-row';
            message.innerHTML = `<td colspan="6" style="text-align: center;">「${searchText}」に一致するカルテはありません</td>`;
            listBody.appendChild(message);
          }
        } else {
          const noResultRow = document.getElementById('no-results-row');
          if (noResultRow) { noResultRow.remove(); }
        }
      },
      
      markHasChanges: function() { 
        this.hasChanges = true; 
      }
    };

    document.addEventListener('DOMContentLoaded', () => { KarteApp.init(); });
  </script>
</body>
</html>
