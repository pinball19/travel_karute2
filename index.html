<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>団体ナビ成約カルテ</title>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.css"
  />
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    .app-container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: white;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      padding: 20px;
      border-radius: 5px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    .app-title h1 {
      margin: 0;
      color: #217346; /* Excel風の緑色 */
    }
    .app-info {
      font-size: 14px;
      color: #666;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      padding: 8px 16px;
      background-color: #217346;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #1a5e38;
    }
    .section-container {
      margin-bottom: 25px;
      border: 1px solid #ddd;
      border-radius: 5px;
      overflow: hidden;
    }
    .section-header {
      padding: 8px 15px;
      font-weight: bold;
      font-size: 16px;
      color: white;
    }
    .grid-container {
      height: auto !important;
      overflow: visible !important;
    }
    footer {
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: #666;
    }
    /* 各セクションの色 */
    .basic-section .section-header { background-color: #4472c4; }
    .payment-section .section-header { background-color: #70ad47; }
    .expense-section .section-header { background-color: #ed7d31; }
    .summary-section .section-header { background-color: #7030a0; }
    /* 行追加ボタン */
    .add-row-btn {
      margin: 5px 10px 10px 0;
      padding: 5px 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      float: right;
    }
    .add-row-btn:hover { background-color: #45a049; }
    /* モーダル */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    .modal-content {
      position: relative;
      background-color: white;
      margin: 50px auto;
      padding: 20px;
      width: 90%;
      max-width: 800px;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .close {
      position: absolute;
      top: 10px; right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
    }
    /* 通知 */
    .notification {
      position: fixed;
      bottom: 20px; right: 20px;
      padding: 10px 20px;
      background-color: #4caf50;
      color: white;
      border-radius: 5px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      display: none;
    }
    /* Handsontable のスクロールバー非表示 */
    .handsontable .wtHolder,
    .handsontable .ht_master .wtHolder,
    .handsontable .wtHider {
      overflow: visible !important;
      height: auto !important;
    }
    .handsontable { height: auto !important; }
    .handsontable .htCore { height: auto !important; }
    .handsontable ::-webkit-scrollbar { display: none !important; }
    .handsontable {
      -ms-overflow-style: none !important;
      scrollbar-width: none !important;
    }
    .handsontable .wtSpreader { height: auto !important; width: auto !important; }
    .ht_clone_top { z-index: 101 !important; }
    /* カルテ一覧テーブル */
    #karte-list {
      width: 100%; border-collapse: collapse; margin-top: 10px;
    }
    #karte-list th, #karte-list td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #karte-list th { background-color: #f2f2f2; }
    #karte-list tr:nth-child(even) { background-color: #f9f9f9; }
    #karte-list tr:hover { background-color: #f1f1f1; }
    .search-container { margin-bottom: 10px; }
    #search {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .edit-btn, .delete-btn {
      padding: 5px 10px;
      margin-right: 5px;
      font-size: 12px;
    }
    .delete-btn { background-color: #f44336; }
    .delete-btn:hover { background-color: #d32f2f; }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="app-title"><h1>団体ナビ成約カルテ</h1></div>
      <div class="app-info">
        <div>カルテID: <span id="current-karte-id">新規カルテ</span></div>
        <div>最終更新: <span id="last-saved">-</span></div>
      </div>
    </header>

    <div class="action-buttons">
      <button id="save-btn">保存</button>
      <button id="new-btn">新規</button>
      <button id="open-btn">開く</button>
      <button id="export-btn">エクスポート</button>
    </div>

    <main>
      <!-- 基本情報 -->
      <div class="section-container basic-section" id="basic-section">
        <div class="section-header">◆ 基本情報</div>
        <div id="basic-grid" class="grid-container"></div>
      </div>
      <!-- 入金情報 -->
      <div class="section-container payment-section" id="payment-section">
        <div class="section-header">◆ 入金情報</div>
        <div id="payment-grid" class="grid-container"></div>
        <button id="add-payment-row" class="add-row-btn">行を追加</button>
      </div>
      <!-- 支払情報 -->
      <div class="section-container expense-section" id="expense-section">
        <div class="section-header">◆ 支払情報</div>
        <div id="expense-grid" class="grid-container"></div>
        <button id="add-expense-row" class="add-row-btn">行を追加</button>
      </div>
      <!-- 収支情報 -->
      <div class="section-container summary-section" id="summary-section">
        <div class="section-header">◆ 収支情報</div>
        <div id="summary-grid" class="grid-container"></div>
      </div>
    </main>

    <footer>
      <div>カルテシステム v1.0</div>
      <div>接続状態: <span id="connection-status">オンライン</span></div>
    </footer>
  </div>

  <!-- カルテ一覧モーダル -->
  <div id="list-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>カルテ一覧</h2>
      <div class="search-container">
        <input type="text" id="search" placeholder="検索..." />
      </div>
      <table id="karte-list">
        <thead>
          <tr>
            <th>カルテNo</th>
            <th>お客様担当者</th>
            <th>団体名</th>
            <th>宿泊日</th>
            <th>人数</th>
            <th>行先</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          <!-- JSで行を追加 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 通知 -->
  <div id="notification" class="notification"></div>

  <!-- スクリプト -->
  <script src="https://cdn.jsdelivr.net/npm/handsontable@latest/dist/handsontable.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <script>
    // ========= Firebase設定 =========
    const firebaseConfig = {
      apiKey: "AIzaSyExample",
      authDomain: "travelkarute.firebaseapp.com",
      projectId: "travelkarute",
      storageBucket: "travelkarute.appspot.com",
      messagingSenderId: "635350270309",
      appId: "1:635350270309:web:2498d21f9f134defeda18c"
    };
    
    // ========= Firebase初期化 =========
    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      try {
        db.enablePersistence({ synchronizeTabs: true })
          .catch(function(err) {
            if (err.code === 'failed-precondition') {
              console.warn("Firestoreパーシステンス: 複数タブでは使用できません");
            } else if (err.code === 'unimplemented') {
              console.warn("このブラウザではFirestoreパーシステンスがサポートされていません");
            }
          });
      } catch (e) {
        console.warn("オフラインパーシステンスの設定エラー:", e);
      }
    } catch (error) {
      console.error("Firebase初期化エラー:", error);
      setTimeout(() => {
        alert("サーバー接続に問題が発生しました。ページをリロードしてください。");
      }, 1000);
    }

    // ========= カルテアプリケーション =========
    const KarteApp = {
      currentId: null,
      hasChanges: false,
      grids: { basic: null, payment: null, expense: null, summary: null },
      templates: {
        basic: [
          ['カルテNo', '', '自社担当者', '', '記入日', '', '個人通No', ''],
          ['お客様担当者', '', '団体名', '', 'お客様電話番号', ''],
          ['宿泊日', '', '泊数', '', '合計人数', ''],
          ['大人男性', '', '大人女性', '', '子供(小学生)', '', '幼児', ''],
          ['成約日', '', '利用年度', '', '', ''],
          ['出発地', '', '行先', '', '', '']
        ],
        payment: [
          ['入金予定日', '入金場所', '入金予定額', '入金日', '入金額', '備考', 'チェック'],
          ['', '', '', '', '', '', ''],
          ['', '', '', '', '', '', ''],
          ['A 入金合計', '', '', '', 0, '', '']
        ],
        expense: [
          ['利用日', '手配先名（該当に〇を付ける）', '電話/FAX', '担当者', '支払予定日', '支払金額', 'チェック', '手配完了'],
          ['', '', '', '', '', '', '', ''],
          ['', '', '', '', '', '', '', ''],
          ['B 支払合計', '', '', '', '', 0, '', '']
        ],
        summary: [
          ['報告日', '', '利益率', '', '利益額', ''],
          ['一人粗利', '', '旅行総額/A', '', '支払総額/B', ''],
          ['人数', '', '特補人数', '', '', '']
        ]
      },
      
      init: function() {
        this.initGrids();
        this.setupEventListeners();
        this.createNew();
        setTimeout(() => { this.adjustTableHeights(); }, 500);
      },

      // ========= グリッド初期化 =========
      initGrids: function() {
        const that = this;
        this.grids.basic = new Handsontable(document.getElementById('basic-grid'), {
          data: this.deepCopy(this.templates.basic),
          rowHeaders: false,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minCols: 8,
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          afterRender: function() {
            try {
              const tableHeight = this.rootElement.querySelector('.htCore').offsetHeight;
              this.rootElement.style.height = tableHeight + 'px';
            } catch (e) {
              console.warn('テーブル高さ調整エラー:', e);
            }
          },
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') { that.markHasChanges(); }
          }
        });
        
        this.grids.payment = new Handsontable(document.getElementById('payment-grid'), {
          data: this.deepCopy(this.templates.payment),
          rowHeaders: true,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minRows: 4,
          contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          cells: (row, col) => {
            const cellProperties = {};
            if ((col === 2 || col === 4) && row > 0) {
              cellProperties.type = 'numeric';
              cellProperties.numericFormat = { pattern: '0,0', culture: 'ja-JP' };
            }
            if (col === 6 && row > 0 && row < that.getRowCount('payment') - 1) {
              cellProperties.type = 'checkbox';
            }
            if (row === that.getRowCount('payment') - 1) {
              cellProperties.readOnly = true;
              if (col === 0) { cellProperties.className = 'total-cell'; }
            }
            return cellProperties;
          },
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              that.calculatePaymentTotal();
              that.markHasChanges();
            }
          },
          afterCreateRow: function(index, amount, source) {
            try {
              const rowCount = this.countRows();
              const data = this.getData();
              if (!data[rowCount - 1][0] || !String(data[rowCount - 1][0]).startsWith('A ')) {
                for (let i = 0; i < rowCount; i++) {
                  if (data[i][0] && String(data[i][0]).startsWith('A ')) {
                    const totalRow = data[i].slice();
                    this.alter('remove_row', i, 1);
                    this.alter('insert_row', rowCount - 1, 1);
                    this.setDataAtRow(rowCount - 1, totalRow);
                    break;
                  }
                }
              }
              that.calculatePaymentTotal();
              that.markHasChanges();
              setTimeout(() => { that.adjustTableHeights(); }, 100);
            } catch (error) { console.error('行追加処理エラー:', error); }
          },
          afterRemoveRow: function(index, amount) {
            that.calculatePaymentTotal();
            that.markHasChanges();
            setTimeout(() => { that.adjustTableHeights(); }, 100);
          }
        });
        
        this.grids.expense = new Handsontable(document.getElementById('expense-grid'), {
          data: this.deepCopy(this.templates.expense),
          rowHeaders: true,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          minRows: 4,
          contextMenu: ['row_above', 'row_below', 'remove_row', '---------', 'undo', 'redo'],
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          cells: (row, col) => {
            const cellProperties = {};
            if (col === 5 && row > 0) {
              cellProperties.type = 'numeric';
              cellProperties.numericFormat = { pattern: '0,0', culture: 'ja-JP' };
            }
            if ((col === 6 || col === 7) && row > 0 && row < that.getRowCount('expense') - 1) {
              cellProperties.type = 'checkbox';
            }
            if (row === that.getRowCount('expense') - 1) {
              cellProperties.readOnly = true;
              if (col === 0) { cellProperties.className = 'total-cell'; }
            }
            return cellProperties;
          },
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              that.calculateExpenseTotal();
              that.markHasChanges();
            }
          },
          afterCreateRow: function(index, amount, source) {
            try {
              const rowCount = this.countRows();
              const data = this.getData();
              if (!data[rowCount - 1][0] || !String(data[rowCount - 1][0]).startsWith('B ')) {
                for (let i = 0; i < rowCount; i++) {
                  if (data[i][0] && String(data[i][0]).startsWith('B ')) {
                    const totalRow = data[i].slice();
                    this.alter('remove_row', i, 1);
                    this.alter('insert_row', rowCount - 1, 1);
                    this.setDataAtRow(rowCount - 1, totalRow);
                    break;
                  }
                }
              }
              that.calculateExpenseTotal();
              that.markHasChanges();
              setTimeout(() => { that.adjustTableHeights(); }, 100);
            } catch (error) { console.error('行追加処理エラー:', error); }
          },
          afterRemoveRow: function(index, amount) {
            that.calculateExpenseTotal();
            that.markHasChanges();
            setTimeout(() => { that.adjustTableHeights(); }, 100);
          }
        });
        
        this.grids.summary = new Handsontable(document.getElementById('summary-grid'), {
          data: this.deepCopy(this.templates.summary),
          rowHeaders: false,
          colHeaders: false,
          height: 'auto',
          stretchH: 'all',
          licenseKey: 'non-commercial-and-evaluation',
          viewportRowRenderingOffset: 100,
          renderAllRows: true,
          overflow: 'visible',
          cells: (row, col) => {
            const cellProperties = {};
            if (col === 1 || col === 3 || col === 5) {
              if (row === 0 && col === 1) {
                cellProperties.type = 'date';
                cellProperties.dateFormat = 'YYYY/MM/DD';
              } else {
                cellProperties.type = 'numeric';
                cellProperties.numericFormat = { pattern: '0,0', culture: 'ja-JP' };
              }
              const readOnlyCells = [[0,3], [0,5], [1,1], [1,3], [1,5]];
              if (readOnlyCells.some(([r,c]) => r === row && c === col)) {
                cellProperties.readOnly = true;
              }
            }
            return cellProperties;
          },
          afterChange: (changes, source) => {
            if (source === 'edit' || source === 'paste') {
              that.markHasChanges();
              that.calculateProfit();
            }
          }
        });
      },
      
      // ========= イベントリスナー =========
      setupEventListeners: function() {
        document.getElementById('save-btn').addEventListener('click', () => { this.saveKarte(); });
        document.getElementById('new-btn').addEventListener('click', () => {
          if (this.hasChanges && !confirm('保存されていない変更があります。新規カルテを作成しますか？')) { return; }
          this.createNew();
        });
        document.getElementById('open-btn').addEventListener('click', () => { this.loadKarteList(); });
        document.getElementById('export-btn').addEventListener('click', () => { this.exportToExcel(); });
        
        // 入金情報: 行を追加
        document.getElementById('add-payment-row').addEventListener('click', () => {
          const hot = this.grids.payment;
          const rowCount = hot.countRows();
          try {
            hot.alter('insert_row', rowCount, 1);
            setTimeout(() => { this.adjustTableHeights(); }, 100);
          } catch (error) {
            console.error('行追加処理エラー:', error);
            try {
              const currentData = hot.getData();
              const totalRow = currentData[rowCount - 1].slice();
              currentData.splice(rowCount - 1, 1);
              currentData.push(Array(totalRow.length).fill(''));
              currentData.push(totalRow);
              hot.loadData(currentData);
              setTimeout(() => { this.adjustTableHeights(); }, 100);
            } catch (innerError) {
              console.error('代替行追加も失敗:', innerError);
              this.showNotification('行の追加に失敗しました', 'error');
            }
          }
        });
        
        // 支払情報: 行を追加
        document.getElementById('add-expense-row').addEventListener('click', () => {
          const hot = this.grids.expense;
          const rowCount = hot.countRows();
          try {
            hot.alter('insert_row', rowCount, 1);
            setTimeout(() => { this.adjustTableHeights(); }, 100);
          } catch (error) {
            console.error('行追加処理エラー:', error);
            try {
              const currentData = hot.getData();
              const totalRow = currentData[rowCount - 1].slice();
              currentData.splice(rowCount - 1, 1);
              currentData.push(Array(totalRow.length).fill(''));
              currentData.push(totalRow);
              hot.loadData(currentData);
              setTimeout(() => { this.adjustTableHeights(); }, 100);
            } catch (innerError) {
              console.error('代替行追加も失敗:', innerError);
              this.showNotification('行の追加に失敗しました', 'error');
            }
          }
        });
        
        // モーダル関連
        document.querySelector('.close').addEventListener('click', () => {
          document.getElementById('list-modal').style.display = 'none';
        });
        document.getElementById('search').addEventListener('input', (e) => { this.filterKarteList(e.target.value); });
        window.addEventListener('click', (event) => {
          if (event.target === document.getElementById('list-modal')) {
            document.getElementById('list-modal').style.display = 'none';
          }
        });
        
        // オンライン・オフライン通知
        window.addEventListener('online', () => {
          document.getElementById('connection-status').textContent = 'オンライン';
          document.getElementById('connection-status').style.color = '';
          this.showNotification('ネットワーク接続が復旧しました', 'success');
        });
        window.addEventListener('offline', () => {
          document.getElementById('connection-status').textContent = 'オフライン';
          document.getElementById('connection-status').style.color = 'red';
          this.showNotification('オフライン状態になりました', 'warning');
        });
        
        // ウィンドウリサイズで高さ再調整
        window.addEventListener('resize', () => {
          clearTimeout(this.resizeTimer);
          this.resizeTimer = setTimeout(() => { this.adjustTableHeights(); }, 200);
        });
        
        // ページ離脱前に変更がある場合は警告
        window.addEventListener('beforeunload', (e) => {
          if (this.hasChanges) {
            e.preventDefault();
            e.returnValue = '保存されていない変更があります。ページを離れますか？';
            return e.returnValue;
          }
        });
      },
      
      // ========= 通知表示メソッド =========
      showNotification: function(message, type = 'info') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        notification.textContent = message;
        switch (type) {
          case 'success': notification.style.backgroundColor = '#4caf50'; break;
          case 'error': notification.style.backgroundColor = '#f44336'; break;
          case 'warning': notification.style.backgroundColor = '#ff9800'; break;
          default: notification.style.backgroundColor = '#2196F3';
        }
        notification.style.display = 'block';
        setTimeout(() => { notification.style.display = 'none'; }, 3000);
      },
      
      // ========= 新規カルテ作成 =========
      createNew: function() {
        this.currentId = null;
        document.getElementById('current-karte-id').textContent = '新規カルテ';
        document.getElementById('last-saved').textContent = '-';
        this.grids.basic.loadData(this.deepCopy(this.templates.basic));
        this.grids.payment.loadData(this.deepCopy(this.templates.payment));
        this.grids.expense.loadData(this.deepCopy(this.templates.expense));
        this.grids.summary.loadData(this.deepCopy(this.templates.summary));
        const today = new Date();
        const y = today.getFullYear();
        const m = ('0' + (today.getMonth() + 1)).slice(-2);
        const d = ('0' + today.getDate()).slice(-2);
        const formattedDate = `${y}/${m}/${d}`;
        this.grids.summary.setDataAtCell(0, 1, formattedDate, 'internal');
        this.grids.basic.setDataAtCell(0, 5, formattedDate, 'internal');
        this.hasChanges = false;
        setTimeout(() => { this.adjustTableHeights(); }, 100);
      },
      
      // ========= 入金合計計算 =========
      calculatePaymentTotal: function() {
        if (!this.grids.payment) return;
        try {
          const data = this.grids.payment.getData();
          let total = 0;
          const lastRowIndex = data.length - 1;
          for (let i = 1; i < lastRowIndex; i++) {
            total += this.parseNumber(data[i][4]);
          }
          this.grids.payment.setDataAtCell(lastRowIndex, 4, total, 'internal');
          if (this.grids.summary) {
            this.grids.summary.setDataAtCell(1, 3, total, 'internal');
            this.calculateProfit();
          }
        } catch (error) {
          console.error('入金合計計算エラー:', error);
        }
      },
      
      // ========= 支払合計計算 =========
      calculateExpenseTotal: function() {
        if (!this.grids.expense) return;
        try {
          const data = this.grids.expense.getData();
          let total = 0;
          const lastRowIndex = data.length - 1;
          for (let i = 1; i < lastRowIndex; i++) {
            total += this.parseNumber(data[i][5]);
          }
          this.grids.expense.setDataAtCell(lastRowIndex, 5, total, 'internal');
          if (this.grids.summary) {
            this.grids.summary.setDataAtCell(1, 5, total, 'internal');
            this.calculateProfit();
          }
        } catch (error) {
          console.error('支払合計計算エラー:', error);
        }
      },
      
      // ========= 利益計算 =========
      calculateProfit: function() {
        if (!this.grids.summary) return;
        try {
          const data = this.grids.summary.getData();
          const income = this.parseNumber(data[1][3]);
          const expense = this.parseNumber(data[1][5]);
          const profit = income - expense;
          this.grids.summary.setDataAtCell(0, 5, profit, 'internal');
          const basicData = this.grids.basic.getData();
          let personCount = 0;
          if (basicData && basicData[2] && basicData[2].length > 5) {
            personCount = this.parseNumber(basicData[2][5]);
          }
          this.grids.summary.setDataAtCell(2, 1, personCount, 'internal');
          let profitRate = 0;
          if (income > 0) {
            profitRate = ((profit / income) * 100).toFixed(1) + '%';
          }
          this.grids.summary.setDataAtCell(0, 3, profitRate, 'internal');
          let profitPerPerson = 0;
          if (personCount > 0) { profitPerPerson = Math.round(profit / personCount); }
          this.grids.summary.setDataAtCell(1, 1, profitPerPerson, 'internal');
        } catch (error) {
          console.error('利益計算エラー:', error);
        }
      },
      
      // ========= Firebase保存 =========
      saveKarte: function() {
        if (!navigator.onLine) {
          this.showNotification('オフライン状態では保存できません', 'error');
          return;
        }
        document.getElementById('last-saved').textContent = '保存中...';
        try {
          // データをJSON文字列として保存
          const basicDataString = JSON.stringify(this.grids.basic ? this.grids.basic.getData() : []);
          const paymentDataString = JSON.stringify(this.grids.payment ? this.grids.payment.getData() : []);
          const expenseDataString = JSON.stringify(this.grids.expense ? this.grids.expense.getData() : []);
          const summaryDataString = JSON.stringify(this.grids.summary ? this.grids.summary.getData() : []);
          
          // 基本情報から抽出したオブジェクトデータは通常のオブジェクトとして保存
          const basicData = this.grids.basic ? this.grids.basic.getData() : [];
          const karteInfo = this.extractKarteInfo(basicData);
          
          const karteData = {
            basicDataString,
            paymentDataString,
            expenseDataString,
            summaryDataString,
            karteInfo,
            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          let savePromise;
          if (this.currentId) {
            savePromise = db.collection('karte').doc(this.currentId).update(karteData);
          } else {
            savePromise = db.collection('karte').add(karteData)
              .then(docRef => { this.currentId = docRef.id; return docRef; });
          }
          
          savePromise.then(() => {
            const now = new Date();
            document.getElementById('last-saved').textContent = now.toLocaleString();
            document.getElementById('current-karte-id').textContent = karteInfo.karteNo || this.currentId;
            this.hasChanges = false;
            this.showNotification('カルテを保存しました', 'success');
          }).catch(error => {
            console.error('保存エラー:', error);
            document.getElementById('last-saved').textContent = '保存失敗';
            this.showNotification('保存に失敗しました: ' + error.message, 'error');
          });
        } catch (error) {
          console.error('データ準備エラー:', error);
          document.getElementById('last-saved').textContent = '保存失敗';
          this.showNotification('データの準備中にエラーが発生しました', 'error');
        }
      },
      
      // ========= Firestore向けデータ変換 (互換性維持のため残す) =========
      prepareDataForFirebase: function(data) {
        if (!data || !Array.isArray(data)) { return []; }
        const processedData = JSON.parse(JSON.stringify(data));
        return processedData.map(row => {
          if (!Array.isArray(row)) return [];
          return row.map(cell => { return this.cleanCellValue(cell); });
        });
      },
      
      // ========= セル値の正規化 =========
      cleanCellValue: function(cell) {
        if (cell === undefined || cell === null) { return ''; }
        if (typeof cell === 'number' && isNaN(cell)) { return 0; }
        if (cell instanceof Date) { return cell.toISOString(); }
        if (typeof cell === 'object') { return JSON.stringify(cell); }
        return cell;
      },
      
      // ========= 基本情報抽出 =========
      extractKarteInfo: function(basicData) {
        const karteInfo = {};
        try {
          if (basicData && basicData.length >= 6) {
            if (basicData[0] && basicData[0].length >= 2) { karteInfo.karteNo = basicData[0][1] || ''; }
            if (basicData[1] && basicData[1].length >= 2) { karteInfo.tantosha = basicData[1][1] || ''; }
            if (basicData[0] && basicData[0].length >= 4) { karteInfo.companyTantosha = basicData[0][3] || ''; }
            if (basicData[1] && basicData[1].length >= 4) { karteInfo.dantaiName = basicData[1][3] || ''; }
            if (basicData[1] && basicData[1].length >= 6) { karteInfo.phoneNumber = basicData[1][5] || ''; }
            if (basicData[2] && basicData[2].length >= 2) { karteInfo.stayDate = basicData[2][1] || ''; }
            if (basicData[2] && basicData[2].length >= 4) { karteInfo.nights = basicData[2][3] || ''; }
            if (basicData[2] && basicData[2].length >= 6) { karteInfo.personCount = basicData[2][5] || ''; }
            if (basicData[5] && basicData[5].length >= 2) { karteInfo.departure = basicData[5][1] || ''; }
            if (basicData[5] && basicData[5].length >= 4) { karteInfo.destination = basicData[5][3] || ''; }
          }
        } catch (e) { console.error('カルテ情報抽出エラー:', e); }
        return karteInfo;
      },
      
      // ========= カルテ一覧読み込み =========
      loadKarteList: function() {
        if (this.hasChanges && !confirm('保存されていない変更があります。カルテ一覧を開きますか？')) { return; }
        const listBody = document.querySelector('#karte-list tbody');
        listBody.innerHTML = '<tr><td colspan="7">読み込み中...</td></tr>';
        document.getElementById('list-modal').style.display = 'block';
        document.getElementById('search').value = '';
        db.collection('karte').orderBy('lastUpdated', 'desc').limit(50).get()
          .then(querySnapshot => {
            if (querySnapshot.empty) {
              listBody.innerHTML = '<tr><td colspan="7">カルテがありません</td></tr>';
              return;
            }
            let html = '';
            querySnapshot.forEach(doc => {
              const data = doc.data();
              const info = data.karteInfo || {};
              html += `
                <tr data-id="${doc.id}">
                  <td>${info.karteNo || '-'}</td>
                  <td>${info.tantosha || '-'}</td>
                  <td>${info.dantaiName || '-'}</td>
                  <td>${info.stayDate || '-'}</td>
                  <td>${info.personCount || '-'}</td>
                  <td>${info.destination || '-'}</td>
                  <td>
                    <button class="edit-btn" data-id="${doc.id}">編集</button>
                    <button class="delete-btn" data-id="${doc.id}">削除</button>
                  </td>
                </tr>
              `;
            });
            listBody.innerHTML = html;
            document.querySelectorAll('.edit-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                this.loadKarte(id);
                document.getElementById('list-modal').style.display = 'none';
              });
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
              btn.addEventListener('click', (e) => {
                const id = e.target.getAttribute('data-id');
                if (confirm('本当に削除しますか？')) { this.deleteKarte(id); }
              });
            });
          })
          .catch(error => {
            console.error('カルテリスト取得エラー:', error);
            listBody.innerHTML = `<tr><td colspan="7">エラー: ${error.message}</td></tr>`;
            this.showNotification('カルテ一覧の取得に失敗しました', 'error');
          });
      },
      
paymentData) {
              this.grids.payment.loadData(data.paymentData);
            }
            
            if (data.expenseDataString) {
              this.grids.expense.loadData(JSON.parse(data.expenseDataString));
            } else if (data.expenseData) {
              this.grids.expense.loadData(data.expenseData);
            }
            
            if (data.summaryDataString) {
              this.grids.summary.loadData(JSON.parse(data.summaryDataString));
            } else if (data.summaryData) {
              this.grids.summary.loadData(data.summaryData);
            }
            
            this.currentId = id;
            const karteInfo = data.karteInfo || {};
            document.getElementById('current-karte-id').textContent = karteInfo.karteNo || id;
            document.getElementById('last-saved').textContent =
              data.lastUpdated ? data.lastUpdated.toDate().toLocaleString() : '-';
            this.hasChanges = false;
            setTimeout(() => { this.adjustTableHeights(); }, 100);
            this.showNotification('カルテを読み込みました', 'success');
          })
          .catch(error => {
            console.error('カルテ読み込みエラー:', error);
            document.getElementById('last-saved').textContent = '読み込み失敗';
            this.showNotification('カルテの読み込みに失敗しました', 'error');
          });
      },
